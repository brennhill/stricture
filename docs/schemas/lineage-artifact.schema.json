{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$comment": "SPDX-License-Identifier: CC-BY-4.0; Copyright (c) 2026 Brenn Hill",
  "$id": "https://stricture.dev/schemas/lineage-artifact.schema.json",
  "title": "Stricture Lineage Artifact",
  "type": "object",
  "required": ["schema_version", "fields"],
  "properties": {
    "schema_version": {
      "type": "string",
      "const": "1"
    },
    "metadata": {
      "type": "object",
      "additionalProperties": true
    },
    "systems": {
      "type": "array",
      "items": { "$ref": "#/$defs/system" }
    },
    "fields": {
      "type": "array",
      "items": { "$ref": "#/$defs/annotation" }
    },
    "edges": {
      "type": "array",
      "items": { "$ref": "#/$defs/edge" }
    },
    "invariants": {
      "type": "array",
      "items": {
        "type": "object",
        "additionalProperties": true
      }
    },
    "findings": {
      "type": "array",
      "items": { "$ref": "#/$defs/finding" }
    },
    "overrides": {
      "type": "array",
      "items": { "$ref": "#/$defs/override" }
    }
  },
  "$defs": {
    "system": {
      "type": "object",
      "required": ["id"],
      "properties": {
        "id": { "type": "string", "pattern": "^[A-Za-z][A-Za-z0-9_-]{0,63}(:[A-Za-z][A-Za-z0-9_-]{0,63})?$" },
        "name": { "type": "string" },
        "owner_team": { "type": "string" },
        "runbook_url": { "type": "string", "format": "uri" },
        "doc_root": { "type": "string", "format": "uri" },
        "kind": { "type": "string" },
        "flows": {
          "type": "array",
          "items": { "type": "string", "minLength": 1 },
          "uniqueItems": true
        }
      },
      "additionalProperties": true
    },
    "edge": {
      "type": "object",
      "required": ["from", "to"],
      "properties": {
        "from": { "type": "string" },
        "to": { "type": "string" },
        "field_id": { "type": "string" },
        "status": { "type": "string" }
      },
      "additionalProperties": true
    },
    "finding": {
      "type": "object",
      "required": ["id"],
      "properties": {
        "id": { "type": "string", "minLength": 1 },
        "rule_id": { "type": "string" },
        "severity": { "type": "string", "enum": ["high", "medium", "low", "info"] },
        "field_id": { "type": "string" },
        "message": { "type": "string" },
        "flow_context": {
          "type": "object",
          "properties": {
            "flow_ids": {
              "type": "array",
              "items": { "type": "string", "minLength": 1 },
              "uniqueItems": true
            },
            "effective_level": { "type": "integer", "minimum": 0 },
            "policy_reason": { "type": "string" }
          },
          "additionalProperties": true
        }
      },
      "additionalProperties": true
    },
    "annotation": {
      "type": "object",
      "required": [
        "annotation_schema_version",
        "field_id",
        "field",
        "source_system",
        "source_version",
        "min_supported_source_version",
        "transform_type",
        "merge_strategy",
        "break_policy",
        "confidence",
        "data_classification",
        "owner",
        "escalation",
        "contract_test_id",
        "introduced_at",
        "sources",
        "flow",
        "note"
      ],
      "properties": {
        "annotation_schema_version": { "type": "string", "const": "1" },
        "field_id": { "type": "string", "pattern": "^[a-z][a-z0-9_]{2,63}$" },
        "renamed_from": { "type": "string", "pattern": "^[a-z][a-z0-9_]{2,63}$" },
        "field": { "type": "string", "pattern": "^[A-Za-z0-9_\\-\\[\\]\\.]+$" },
        "source_system": { "type": "string", "pattern": "^[A-Za-z][A-Za-z0-9_-]{0,63}(:[A-Za-z][A-Za-z0-9_-]{0,63})?$" },
        "source_version": { "type": "string", "pattern": "^[A-Za-z0-9][A-Za-z0-9._-]{0,63}$" },
        "min_supported_source_version": { "type": "string", "pattern": "^[A-Za-z0-9][A-Za-z0-9._-]{0,63}$" },
        "transform_type": {
          "type": "string",
          "enum": ["passthrough", "normalize", "derive", "aggregate", "mask", "join"]
        },
        "merge_strategy": {
          "type": "string",
          "enum": ["single_source", "priority", "first_non_null", "union", "custom"]
        },
        "break_policy": {
          "type": "string",
          "enum": ["additive_only", "strict", "opaque"]
        },
        "confidence": {
          "type": "string",
          "enum": ["declared", "inferred"]
        },
        "data_classification": {
          "type": "string",
          "enum": ["public", "internal", "sensitive", "regulated"]
        },
        "owner": { "type": "string", "pattern": "^[a-z][a-z0-9_.-]{2,63}$" },
        "escalation": { "type": "string", "pattern": "^[a-z]+:.+$" },
        "contract_test_id": { "type": "string", "minLength": 1 },
        "introduced_at": { "type": "string", "format": "date" },
        "sunset_at": { "type": "string", "format": "date" },
        "sources": {
          "type": "array",
          "minItems": 1,
          "items": { "$ref": "#/$defs/source_ref" }
        },
        "flow": { "type": "string", "pattern": "^from @[A-Za-z][A-Za-z0-9_-]*(:[A-Za-z][A-Za-z0-9_-]*)?( (enriched|normalized|derived|validated|mapped|merged) @[A-Za-z][A-Za-z0-9_-]*(:[A-Za-z][A-Za-z0-9_-]*)?)*$" },
        "note": { "type": "string", "minLength": 1 },
        "file_path": { "type": "string" },
        "line": { "type": "integer", "minimum": 1 }
      }
    },
    "source_ref": {
      "type": "object",
      "required": ["kind", "target", "path", "scope", "contract_ref", "raw"],
      "properties": {
        "kind": { "type": "string", "enum": ["api", "input", "db", "event", "file", "cache"] },
        "target": { "type": "string", "minLength": 1 },
        "path": { "type": "string", "minLength": 1 },
        "scope": { "type": "string", "enum": ["internal", "cross_repo", "external"] },
        "as_of": { "type": "string", "format": "date" },
        "provider_id": { "type": "string", "pattern": "^[a-z][a-z0-9_-]{1,63}$" },
        "upstream_system": { "type": "string", "pattern": "^[A-Za-z][A-Za-z0-9_-]{0,63}(:[A-Za-z][A-Za-z0-9_-]{0,63})?$" },
        "contract_ref": { "type": "string", "minLength": 1 },
        "raw": { "type": "string", "minLength": 1 }
      }
    },
    "override": {
      "type": "object",
      "required": ["field_id", "change_type", "expires", "reason", "line"],
      "properties": {
        "field_id": { "type": "string", "pattern": "^[a-z][a-z0-9_]{2,63}$" },
        "change_type": { "type": "string", "pattern": "^(\\*|[a-z][a-z0-9_-]{1,63})$" },
        "expires": { "type": "string", "format": "date" },
        "reason": { "type": "string", "minLength": 1 },
        "ticket": { "type": "string" },
        "file_path": { "type": "string" },
        "line": { "type": "integer", "minimum": 1 }
      }
    }
  }
}
