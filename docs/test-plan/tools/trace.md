# Runtime Trace Audit Tests

Tests for `stricture trace` -- validating runtime traffic against manifest contracts.

Reference: [Product Spec, Section 13.8](../../product-spec.md#138-the-stricture-trace-command)

---

## 1. HAR Format Parsing

### 1.1 Valid HAR Files

**Test ID: HAR-VALID-01: Standard HAR 1.2 with full request/response bodies**

- **Input:** HAR file with `log.version: "1.2"`, containing 5 entries -- 3 GET requests and 2 POST requests with JSON request/response bodies.
- **Manifest:**
```yaml
contracts:
  - id: "user-api"
    producer: user-service
    consumers: [web-frontend]
    protocol: http
    endpoints:
      - path: "/api/users/:id"
        method: GET
        response:
          fields:
            id:   { type: integer, range: [1, 2147483647], required: true }
            name: { type: string, minLength: 1, maxLength: 255, required: true }
        status_codes: [200, 404, 500]
      - path: "/api/users"
        method: POST
        request:
          fields:
            name:  { type: string, minLength: 1, maxLength: 255, required: true }
            email: { type: string, format: email, required: true }
        response:
          fields:
            id:   { type: integer, range: [1, 2147483647], required: true }
            name: { type: string, minLength: 1, maxLength: 255, required: true }
        status_codes: [201, 400, 500]
```
- **Expected:** All 5 entries matched to contracts, 0 violations, exit code 0.
- **Pass criteria:** Summary line shows "5 matched, 0 violations, 0 unmatched".

**Test ID: HAR-VALID-02: HAR with many entries (100+ requests)**

- **Input:** HAR file with 150 entries, all GET requests to `/api/users/:id` with valid JSON responses containing all required fields.
- **Manifest:** Same `user-api` contract as HAR-VALID-01.
- **Expected:** All 150 entries matched, 0 violations, processing completes without error.
- **Pass criteria:** Summary shows "150 matched". No timeout or memory errors.

**Test ID: HAR-VALID-03: HAR with only GET requests (no bodies)**

- **Input:** HAR file with 10 GET requests. `request.postData` absent (GET has no body). Responses have JSON bodies.
- **Manifest:** Endpoint with `method: GET` and response fields declared.
- **Expected:** All 10 matched, request body validation skipped, response fields validated.
- **Pass criteria:** No error about missing request body. Response field checks reported.

**Test ID: HAR-VALID-04: HAR with POST requests containing JSON bodies**

- **Input:** HAR file with 5 POST requests. `request.postData.mimeType: "application/json"`, `request.postData.text: '{"name":"Alice","email":"alice@example.com"}'`.
- **Manifest:** POST endpoint with request fields `name` (string, required) and `email` (string, format: email, required).
- **Expected:** All 5 matched, request fields validated against manifest, 0 violations.
- **Pass criteria:** Both request and response fields checked.

**Test ID: HAR-VALID-05: HAR with multipart form data**

- **Input:** HAR file with POST request. `request.postData.mimeType: "multipart/form-data"`, `request.postData.params` array with name/value pairs.
- **Manifest:** POST endpoint with request fields matching the form field names.
- **Expected:** Form field values extracted and validated against manifest field constraints.
- **Pass criteria:** Multipart params parsed correctly. Field values validated.

**Test ID: HAR-VALID-06: HAR exported from Chrome DevTools**

- **Input:** Real Chrome DevTools HAR export (includes `creator: { name: "WebInspector", version: "..." }`, `pages` array, full timing data).
- **Manifest:** Contract matching at least one endpoint in the HAR.
- **Expected:** Parsed successfully. Extra Chrome-specific fields (`_initiator`, `_priority`, `_resourceType`) ignored.
- **Pass criteria:** No parse errors. Entries matched and validated.

**Test ID: HAR-VALID-07: HAR exported from Gasoline**

- **Input:** HAR generated by Gasoline's `generate --format har` command.
- **Manifest:** Contract matching the captured endpoints.
- **Expected:** Parsed successfully. Gasoline-specific metadata (`_gasolineSessionId`, etc.) ignored.
- **Pass criteria:** Entries matched and validated with no warnings about unknown fields.

**Test ID: HAR-VALID-08: HAR exported from Charles Proxy**

- **Input:** Charles Proxy HAR export (includes `creator: { name: "Charles", version: "..." }`, may include SSL fields, `connection` fields).
- **Manifest:** Contract matching captured endpoints.
- **Expected:** Parsed successfully. Proxy-specific fields ignored.
- **Pass criteria:** No parse errors from Charles-specific HAR extensions.

### 1.2 HAR Edge Cases

**Test ID: HAR-EDGE-01: Compressed response bodies (Content-Encoding: gzip)**

- **Input:** HAR entry with `response.content.encoding: "base64"`, `response.headers` includes `Content-Encoding: gzip`. `response.content.text` is base64-encoded gzip content.
- **Manifest:** Endpoint with response field constraints.
- **Expected:** Body decoded from base64, decompressed from gzip, then validated as JSON.
- **Pass criteria:** Fields extracted from decompressed body. Validation runs normally.

**Test ID: HAR-EDGE-02: Base64-encoded bodies**

- **Input:** HAR entry with `response.content.encoding: "base64"`, `response.content.text` is base64-encoded JSON string.
- **Manifest:** Endpoint with response field constraints.
- **Expected:** Body decoded from base64, parsed as JSON, fields validated.
- **Pass criteria:** Correct field values extracted after base64 decoding.

**Test ID: HAR-EDGE-03: Binary response bodies (images, PDFs)**

- **Input:** HAR entry with `response.content.mimeType: "image/png"`, body is binary data.
- **Manifest:** Endpoint exists in manifest.
- **Expected:** Body validation skipped for non-JSON content types. Entry counted as matched but body validation marked as "skipped (binary)".
- **Pass criteria:** No parse error. Entry still counted in matched total. No body field violations reported.

**Test ID: HAR-EDGE-04: Empty response bodies (204 No Content)**

- **Input:** HAR entry with `response.status: 204`, `response.content.text: ""` or absent.
- **Manifest:** Endpoint with `status_codes: [200, 204, 400]`, response fields declared.
- **Expected:** Status code 204 accepted. Response body validation skipped (204 has no body by definition). No "missing required field" violations.
- **Pass criteria:** 204 counted as matched. No field violations for empty body. Status code check passes.

**Test ID: HAR-EDGE-05: Redirect chains (301 -> 302 -> 200)**

- **Input:** HAR with three entries forming a redirect chain: Entry 1 (status 301, Location header), Entry 2 (status 302, Location header), Entry 3 (status 200, JSON body).
- **Manifest:** Endpoint matches the final URL, `status_codes: [200, 301, 302]`.
- **Expected:** Each entry validated independently. Redirect entries (301, 302) have no body to validate. Final 200 response body validated.
- **Pass criteria:** All three entries matched. Body validation only on the 200 response.

**Test ID: HAR-EDGE-06: Failed requests (0 status, connection refused)**

- **Input:** HAR entry with `response.status: 0`, no response body, `response._error: "net::ERR_CONNECTION_REFUSED"`.
- **Manifest:** Endpoint exists in manifest.
- **Expected:** Entry matched to contract. Status 0 reported as a special case: "connection failure". No body validation attempted. Warning emitted: "1 request failed (connection error)".
- **Pass criteria:** Not counted as a status code violation. Counted separately in summary.

**Test ID: HAR-EDGE-07: Very large response bodies (>1MB)**

- **Input:** HAR entry with `response.content.text` containing >1MB of valid JSON (e.g., array of 50,000 objects).
- **Manifest:** Endpoint with response field constraints on array element fields.
- **Expected:** Parsed and validated without memory issues. Each array element checked if manifest specifies array element fields.
- **Pass criteria:** Processing completes. No OOM. Violations (if any) reported correctly.

**Test ID: HAR-EDGE-08: HAR with websocket entries**

- **Input:** HAR file containing websocket upgrade entries (`response.status: 101`, `request.url` starts with `wss://`).
- **Manifest:** HTTP contracts only (no websocket contracts).
- **Expected:** WebSocket entries skipped silently.
- **Pass criteria:** No error. WebSocket entries not counted in matched or unmatched totals. Log message: "Skipped N websocket entries".

**Test ID: HAR-EDGE-09: HAR missing optional fields**

- **Input:** HAR file with `log.version: "1.2"`, `log.entries` present. No `log.creator`, no `log.comment`, no `log.pages`, no `log.browser`.
- **Manifest:** Valid contract.
- **Expected:** Parsed successfully. Missing optional fields do not cause errors.
- **Pass criteria:** No warnings about missing optional fields.

**Test ID: HAR-EDGE-10: HAR with timing data**

- **Input:** HAR entries with full `timings` objects (`blocked`, `dns`, `connect`, `send`, `wait`, `receive`, `ssl`).
- **Manifest:** Valid contract.
- **Expected:** Timing data completely ignored for validation purposes.
- **Pass criteria:** No output references timing data. Validation based only on request/response content.

### 1.3 Invalid HAR Files

**Test ID: HAR-INVALID-01: Not JSON**

- **Input:** File containing `This is not JSON at all.`
- **Command:** `stricture trace not-json.har`
- **Expected:** Exit code 2. Error message: `Parse error: not-json.har is not valid JSON`.
- **Pass criteria:** Exit code 2. Error message mentions "not valid JSON" or "JSON parse error".

**Test ID: HAR-INVALID-02: JSON but not HAR structure**

- **Input:** File containing `{"users": [{"id": 1}]}` (valid JSON, but no HAR structure).
- **Command:** `stricture trace wrong-structure.har`
- **Expected:** Exit code 2. Error message: `Parse error: wrong-structure.har is not a valid HAR file (missing log.entries)`.
- **Pass criteria:** Exit code 2. Error identifies the structural problem.

**Test ID: HAR-INVALID-03: Missing log.entries**

- **Input:** File containing `{"log": {"version": "1.2", "creator": {"name": "test"}}}` (HAR structure but no `entries` array).
- **Expected:** Exit code 2. Error: `Parse error: HAR file has no entries`.
- **Pass criteria:** Exit code 2. Clear message about missing entries.

**Test ID: HAR-INVALID-04: Missing log.version**

- **Input:** HAR file with valid `log.entries` but no `log.version` field.
- **Expected:** Warning: `HAR file missing version field, assuming 1.2`. Parsing continues. Validation proceeds normally.
- **Pass criteria:** Warning emitted but processing continues. Exit code based on validation results, not the warning.

**Test ID: HAR-INVALID-05: Truncated HAR file**

- **Input:** File containing `{"log": {"version": "1.2", "entries": [{"request": {"method": "GET"` (JSON truncated mid-object).
- **Expected:** Exit code 2. Error: `Parse error: truncated JSON in file.har (unexpected end of input)`.
- **Pass criteria:** Exit code 2. Error mentions truncation or unexpected end of input.

**Test ID: HAR-INVALID-06: HAR with wrong version**

- **Input:** HAR file with `log.version: "2.0"`, valid entries.
- **Expected:** Warning: `HAR version "2.0" is not "1.2", parsing may be unreliable`. Parsing proceeds with best-effort.
- **Pass criteria:** Warning about version mismatch. Validation attempts to proceed.

---

## 2. OpenTelemetry Format Parsing

### 2.1 JSON Export

**Test ID: OTEL-JSON-01: Standard OTel JSON trace export**

- **Input:** OTel JSON file with `resourceSpans` array, containing `scopeSpans` with HTTP client spans.
```json
{
  "resourceSpans": [{
    "resource": { "attributes": [{ "key": "service.name", "value": { "stringValue": "user-service" } }] },
    "scopeSpans": [{
      "spans": [{
        "name": "GET /api/users/42",
        "kind": 3,
        "attributes": [
          { "key": "http.method", "value": { "stringValue": "GET" } },
          { "key": "http.url", "value": { "stringValue": "http://localhost:8080/api/users/42" } },
          { "key": "http.status_code", "value": { "intValue": 200 } }
        ]
      }]
    }]
  }]
}
```
- **Manifest:** `user-api` contract with `GET /api/users/:id`.
- **Expected:** Span matched to `GET /api/users/:id` endpoint, status code 200 validated.
- **Pass criteria:** 1 matched, 0 violations.

**Test ID: OTEL-JSON-02: Multiple spans per trace**

- **Input:** OTel JSON with a single trace containing 8 spans -- 5 HTTP client spans and 3 internal spans.
- **Manifest:** Contracts covering the 5 HTTP endpoints.
- **Expected:** 5 HTTP spans matched to contracts, 3 internal spans skipped.
- **Pass criteria:** Summary shows "5 matched, 0 unmatched". Internal spans not reported.

**Test ID: OTEL-JSON-03: Span attributes for HTTP method, path, status code**

- **Input:** Span with `http.method: "POST"`, `http.target: "/api/users"`, `http.status_code: 201`.
- **Manifest:** POST `/api/users` with `status_codes: [201, 400, 500]`.
- **Expected:** Matched by method + path. Status code 201 validated as in declared set.
- **Pass criteria:** 1 matched, 0 violations.

**Test ID: OTEL-JSON-04: Span with request/response body attributes**

- **Input:** Span with custom attributes `http.request.body: '{"name":"Alice","email":"alice@example.com"}'` and `http.response.body: '{"id":1,"name":"Alice"}'`.
- **Manifest:** POST endpoint with request and response field constraints.
- **Expected:** Request and response bodies parsed from span attributes and validated against manifest.
- **Pass criteria:** Field validation runs on both request and response bodies extracted from span attributes.

**Test ID: OTEL-JSON-05: Nested spans (parent-child)**

- **Input:** OTel trace with parent span (API gateway) and child span (downstream service call). Both have HTTP attributes.
- **Manifest:** Contracts for both endpoints.
- **Expected:** Each span validated independently. Parent-child relationship does not affect validation.
- **Pass criteria:** Both spans matched and validated. No duplication in results.

### 2.2 Span-to-Endpoint Matching

**Test ID: OTEL-MATCH-01: HTTP span with http.method + http.url**

- **Input:** Span with `http.method: "GET"`, `http.url: "https://api.example.com/api/users/42"`.
- **Manifest:** `GET /api/users/:id` endpoint.
- **Expected:** URL path `/api/users/42` extracted, matched to `/api/users/:id`.
- **Pass criteria:** Matched successfully. Host and scheme ignored for matching.

**Test ID: OTEL-MATCH-02: gRPC span with rpc.service + rpc.method**

- **Input:** Span with `rpc.system: "grpc"`, `rpc.service: "UserService"`, `rpc.method: "GetUser"`, `rpc.grpc.status_code: 0`.
- **Manifest:** (Future feature) gRPC contract for `UserService.GetUser`.
- **Expected:** If gRPC contracts exist in manifest, span matched. If not, span skipped with info message.
- **Pass criteria:** gRPC spans handled gracefully whether or not manifest has gRPC contracts.

**Test ID: OTEL-MATCH-03: Span without HTTP attributes**

- **Input:** Span with `name: "process_queue"`, no `http.method`, no `http.url`, no `rpc.service`.
- **Manifest:** HTTP contracts only.
- **Expected:** Span skipped. Not counted as unmatched (it is simply not an HTTP span).
- **Pass criteria:** Span silently skipped. No error or warning.

**Test ID: OTEL-MATCH-04: Span with internal service name -- --service flag**

- **Input:** OTel JSON with spans from 3 services: `user-service`, `billing-service`, `api-gateway`.
- **Command:** `stricture trace trace.json --service user-service`
- **Manifest:** Contracts for all 3 services.
- **Expected:** Only spans with `service.name: "user-service"` validated. Other service spans skipped.
- **Pass criteria:** Summary only includes spans from `user-service`.

### 2.3 Edge Cases

**Test ID: OTEL-EDGE-01: Trace with spans from multiple services**

- **Input:** OTel JSON with 20 spans from 4 different services (identified by `resource.attributes.service.name`).
- **Command:** `stricture trace trace.json` (no `--service` flag).
- **Manifest:** Contracts covering endpoints from all 4 services.
- **Expected:** All HTTP spans from all services matched to their respective contracts.
- **Pass criteria:** Cross-service validation works. Violations reported per-contract.

**Test ID: OTEL-EDGE-02: Span with no response attributes (error/timeout)**

- **Input:** Span with `http.method: "GET"`, `http.url`, but no `http.status_code`. Span has `otel.status_code: "ERROR"`, `otel.status_message: "deadline exceeded"`.
- **Manifest:** GET endpoint.
- **Expected:** Matched to contract. Status code reported as missing. Warning: "1 span had no response (timeout/error)".
- **Pass criteria:** Not a field violation. Counted separately in summary.

**Test ID: OTEL-EDGE-03: Very long trace (10,000+ spans)**

- **Input:** OTel JSON with 10,000 spans from a load test.
- **Manifest:** 5 endpoint contracts.
- **Expected:** All spans processed. Performance acceptable (completes in under 10s).
- **Pass criteria:** No timeout. No memory exhaustion. Summary totals correct.

**Test ID: OTEL-EDGE-04: Trace exported from Jaeger vs Zipkin format**

- **Input (a):** Jaeger JSON export format (different structure from OTel native).
- **Input (b):** Zipkin JSON v2 format.
- **Expected (a):** If Jaeger format supported, parse successfully. If not, clear error: `Unsupported OTel format: Jaeger. Use OTel JSON export instead.`
- **Expected (b):** If Zipkin format supported, parse successfully. If not, clear error with suggestion to convert.
- **Pass criteria:** Either parsed correctly or rejected with actionable error message.

---

## 3. Custom JSON Format

### 3.1 Valid Format

**Test ID: CUSTOM-VALID-01: Array of complete entries**

- **Input:**
```json
[
  { "method": "GET", "path": "/api/users/1", "request_body": null, "response_body": {"id": 1, "name": "Alice", "role": "admin"}, "status": 200 },
  { "method": "POST", "path": "/api/users", "request_body": {"name": "Bob", "email": "bob@example.com"}, "response_body": {"id": 2, "name": "Bob"}, "status": 201 }
]
```
- **Manifest:** `user-api` with GET `/api/users/:id` and POST `/api/users` endpoints.
- **Expected:** 2 matched, 0 violations.
- **Pass criteria:** Both entries parsed and matched correctly.

**Test ID: CUSTOM-VALID-02: All fields present**

- **Input:** Single entry with all five fields (`method`, `path`, `request_body`, `response_body`, `status`) fully populated.
- **Manifest:** Matching endpoint.
- **Expected:** Request body, response body, and status all validated.
- **Pass criteria:** All three validation types (request fields, response fields, status code) executed.

**Test ID: CUSTOM-VALID-03: Optional fields missing (request_body null for GET)**

- **Input:**
```json
[{ "method": "GET", "path": "/api/users/5", "response_body": {"id": 5, "name": "Charlie"}, "status": 200 }]
```
- **Manifest:** GET endpoint with response fields.
- **Expected:** `request_body` absent or null is acceptable for GET. Response body validated.
- **Pass criteria:** No error about missing `request_body`.

**Test ID: CUSTOM-VALID-04: Nested JSON in body fields**

- **Input:**
```json
[{
  "method": "POST", "path": "/api/orders", "status": 201,
  "request_body": {
    "user_id": 1,
    "items": [{"product_id": 10, "quantity": 2}],
    "shipping": {"address": {"street": "123 Main St", "city": "Springfield"}}
  },
  "response_body": {"order_id": "abc-123", "total": 59.99}
}]
```
- **Manifest:** POST `/api/orders` with nested field constraints.
- **Expected:** Nested fields validated at all levels.
- **Pass criteria:** Nested field paths reported in violations (e.g., `shipping.address.city`).

### 3.2 Edge Cases

**Test ID: CUSTOM-EDGE-01: Empty array**

- **Input:** `[]`
- **Manifest:** Valid contract.
- **Expected:** Exit code 0. Output: "0 requests matched, 0 violations, 0 unmatched".
- **Pass criteria:** No error. Clean summary with zero counts.

**Test ID: CUSTOM-EDGE-02: Single entry**

- **Input:** Array with exactly 1 entry.
- **Manifest:** Matching endpoint.
- **Expected:** 1 matched. Validation runs normally.
- **Pass criteria:** Works identically to multi-entry input.

**Test ID: CUSTOM-EDGE-03: Body fields as strings (JSON-encoded) vs objects**

- **Input (a):** `response_body: "{\"id\": 1, \"name\": \"Alice\"}"` (string containing JSON).
- **Input (b):** `response_body: {"id": 1, "name": "Alice"}` (JSON object directly).
- **Manifest:** Endpoint with response field constraints on `id` and `name`.
- **Expected (a):** String detected as JSON, parsed, and validated.
- **Expected (b):** Object validated directly.
- **Pass criteria:** Both inputs produce identical validation results.

**Test ID: CUSTOM-EDGE-04: Status as string vs number**

- **Input (a):** `"status": "200"` (string).
- **Input (b):** `"status": 200` (number).
- **Manifest:** Endpoint with `status_codes: [200, 400, 500]`.
- **Expected:** Both accepted. String "200" coerced to integer 200.
- **Pass criteria:** No type error. Status code validation works for both.

**Test ID: CUSTOM-EDGE-05: Extra fields ignored**

- **Input:**
```json
[{ "method": "GET", "path": "/api/users/1", "response_body": {"id": 1}, "status": 200, "duration_ms": 42, "source": "test-suite" }]
```
- **Expected:** `duration_ms` and `source` ignored. Validation proceeds on known fields only.
- **Pass criteria:** No warning about extra fields in trace format. (Extra fields in the body are a different concern -- governed by manifest strictness.)

### 3.3 Invalid Format

**Test ID: CUSTOM-INVALID-01: Not an array**

- **Input:** `{ "method": "GET", "path": "/api/users/1", "status": 200 }` (object, not array).
- **Expected:** Exit code 2. Error: `Parse error: custom JSON trace must be an array of request entries`.
- **Pass criteria:** Clear error about expected array.

**Test ID: CUSTOM-INVALID-02: Missing method field**

- **Input:**
```json
[
  { "path": "/api/users/1", "response_body": {"id": 1}, "status": 200 },
  { "method": "GET", "path": "/api/users/2", "response_body": {"id": 2}, "status": 200 }
]
```
- **Expected:** First entry skipped with warning: `Entry 1: skipped (missing "method" field)`. Second entry validated normally.
- **Pass criteria:** Warning for skipped entry. Valid entries still processed. Summary shows 1 matched, 1 skipped.

**Test ID: CUSTOM-INVALID-03: Missing path field**

- **Input:**
```json
[
  { "method": "GET", "response_body": {"id": 1}, "status": 200 }
]
```
- **Expected:** Entry skipped with warning: `Entry 1: skipped (missing "path" field)`.
- **Pass criteria:** Warning emitted. 0 matched, 1 skipped.

---

## 4. Contract Matching

### 4.1 URL Matching

**Test ID: MATCH-URL-01: Exact path match**

- **Input:** Request with `path: "/api/users"`.
- **Manifest:** Endpoint `path: "/api/users"`, `method: POST`.
- **Expected:** Matched to `/api/users` endpoint.
- **Pass criteria:** Exact string match succeeds.

**Test ID: MATCH-URL-02: Single path parameter**

- **Input:** Request with `path: "/api/users/123"`.
- **Manifest:** Endpoint `path: "/api/users/:id"`.
- **Expected:** Matched. `123` recognized as value for `:id` parameter.
- **Pass criteria:** Path parameter segment matched.

**Test ID: MATCH-URL-03: Multiple path parameters**

- **Input:** Request with `path: "/api/orgs/1/users/2"`.
- **Manifest:** Endpoint `path: "/api/orgs/:orgId/users/:userId"`.
- **Expected:** Matched. `1` bound to `:orgId`, `2` bound to `:userId`.
- **Pass criteria:** Both parameter segments matched correctly.

**Test ID: MATCH-URL-04: Query parameters ignored for matching**

- **Input:** Request with `path: "/api/users?page=2&limit=10"`.
- **Manifest:** Endpoint `path: "/api/users"`, `method: GET`.
- **Expected:** Query string stripped before matching. Matched to `/api/users`.
- **Pass criteria:** Query parameters do not prevent matching.

**Test ID: MATCH-URL-05: Fragment ignored for matching**

- **Input:** Request with `path: "/api/users#section"`.
- **Manifest:** Endpoint `path: "/api/users"`.
- **Expected:** Fragment stripped. Matched to `/api/users`.
- **Pass criteria:** Fragment does not prevent matching.

**Test ID: MATCH-URL-06: Trailing slash normalization**

- **Input (a):** Request with `path: "/api/users/"`.
- **Input (b):** Request with `path: "/api/users"`.
- **Manifest:** Endpoint `path: "/api/users"`.
- **Expected:** Both matched. Trailing slash normalized before matching.
- **Pass criteria:** Both inputs match the same endpoint.

**Test ID: MATCH-URL-07: Case sensitivity (lowercase normalized)**

- **Input:** Request with `path: "/API/Users/123"`.
- **Manifest:** Endpoint `path: "/api/users/:id"`.
- **Expected:** Matched after case normalization. Path comparison is case-insensitive.
- **Pass criteria:** Case difference does not prevent matching.

**Test ID: MATCH-URL-08: Path with encoded characters**

- **Input:** Request with `path: "/api/users/john%20doe"`.
- **Manifest:** Endpoint `path: "/api/users/:id"`.
- **Expected:** URL-decoded path matched to parameterized endpoint.
- **Pass criteria:** Encoded characters decoded before matching.

**Test ID: MATCH-URL-09: Deep nested path parameters**

- **Input:** Request with `path: "/api/v2/orgs/acme/teams/backend/members/42/roles"`.
- **Manifest:** Endpoint `path: "/api/v2/orgs/:orgSlug/teams/:teamSlug/members/:memberId/roles"`.
- **Expected:** All 3 parameters matched. Static segments (`api`, `v2`, `roles`) matched exactly.
- **Pass criteria:** Mixed static and parameterized segments matched correctly.

**Test ID: MATCH-URL-10: Path parameter at root**

- **Input:** Request with `path: "/123"`.
- **Manifest:** Endpoint `path: "/:id"`.
- **Expected:** Matched.
- **Pass criteria:** Single-segment parameterized path works.

### 4.2 Method Matching

**Test ID: MATCH-METHOD-01: GET matches GET endpoint**

- **Input:** Request with `method: "GET"`, `path: "/api/users/1"`.
- **Manifest:** Endpoint `method: GET`, `path: "/api/users/:id"`.
- **Expected:** Matched.
- **Pass criteria:** Method and path both match.

**Test ID: MATCH-METHOD-02: POST matches POST endpoint**

- **Input:** Request with `method: "POST"`, `path: "/api/users"`.
- **Manifest:** Endpoint `method: POST`, `path: "/api/users"`.
- **Expected:** Matched.
- **Pass criteria:** POST method correctly paired.

**Test ID: MATCH-METHOD-03: Same path, different methods match different contracts**

- **Input (a):** Request with `method: "GET"`, `path: "/api/users"`.
- **Input (b):** Request with `method: "POST"`, `path: "/api/users"`.
- **Manifest:**
```yaml
endpoints:
  - path: "/api/users"
    method: GET
    response:
      fields:
        users: { type: array, required: true }
    status_codes: [200]
  - path: "/api/users"
    method: POST
    request:
      fields:
        name: { type: string, required: true }
    status_codes: [201, 400]
```
- **Expected:** Each request matched to the correct endpoint by method.
- **Pass criteria:** GET request validated against GET contract. POST request validated against POST contract. Violations reported under the correct endpoint.

**Test ID: MATCH-METHOD-04: Method case insensitive**

- **Input:** Request with `method: "get"`.
- **Manifest:** Endpoint `method: GET`.
- **Expected:** Matched after uppercasing.
- **Pass criteria:** Lowercase method matches uppercase manifest method.

**Test ID: MATCH-METHOD-05: PUT, DELETE, PATCH methods**

- **Input:** Three requests with `method: "PUT"`, `method: "DELETE"`, `method: "PATCH"`, all to `/api/users/1`.
- **Manifest:** Three endpoints with matching methods and path.
- **Expected:** Each matched to its respective endpoint.
- **Pass criteria:** All HTTP methods handled correctly.

**Test ID: MATCH-METHOD-06: HEAD and OPTIONS methods**

- **Input:** Request with `method: "HEAD"`, `path: "/api/users/1"`.
- **Manifest:** Only `GET /api/users/:id` declared.
- **Expected:** HEAD request unmatched (HEAD is a distinct method from GET in the manifest).
- **Pass criteria:** HEAD counted as unmatched unless manifest explicitly declares a HEAD endpoint.

### 4.3 Unmatched Requests

**Test ID: MATCH-UNMATCHED-01: Request with no matching manifest endpoint**

- **Input:** Request with `method: "GET"`, `path: "/api/products/1"`.
- **Manifest:** Only `user-api` contract (no products endpoint).
- **Expected:** Reported as unmatched: `GET /api/products/1`.
- **Pass criteria:** Counted in unmatched total. Not an error (exit code 0 unless `--strict`).

**Test ID: MATCH-UNMATCHED-02: Health check endpoints**

- **Input:** 30 requests to `GET /healthz` and 27 requests to `GET /metrics`.
- **Manifest:** No endpoints for `/healthz` or `/metrics`.
- **Expected:** All 57 reported as unmatched, grouped by path:
```
Unmatched requests: 57 (no manifest contract)
  GET /healthz (30)
  GET /metrics (27)
```
- **Pass criteria:** Unmatched grouped and counted. Not violations.

**Test ID: MATCH-UNMATCHED-03: Static file requests**

- **Input:** Requests to `GET /static/app.js`, `GET /static/style.css`, `GET /favicon.ico`.
- **Manifest:** Only API endpoints declared.
- **Expected:** Static file requests reported as unmatched.
- **Pass criteria:** Grouped under unmatched. Potentially groupable as `GET /static/* (N)`.

**Test ID: MATCH-UNMATCHED-04: Summary includes unmatched count grouped by path**

- **Input:** 10 requests: 5 matched to contracts, 3 to `/healthz`, 2 to `/api/unknown`.
- **Expected output:**
```
Unmatched requests: 5 (no manifest contract)
  GET /healthz (3)
  GET /api/unknown (2)
```
- **Pass criteria:** Unmatched requests grouped by method+path with counts.

**Test ID: MATCH-UNMATCHED-05: All requests unmatched**

- **Input:** 20 requests, none matching any manifest endpoint.
- **Manifest:** Contracts exist but for different paths.
- **Expected:** "0 matched, 0 violations, 20 unmatched". Exit code 0 (no violations).
- **Pass criteria:** No crash. Clean summary. Exit code 0.

### 4.4 Multi-Contract Matching

**Test ID: MATCH-MULTI-01: Ambiguous path -- request matches multiple contracts**

- **Manifest:**
```yaml
contracts:
  - id: "service-a"
    endpoints:
      - path: "/api/users/:id"
        method: GET
  - id: "service-b"
    endpoints:
      - path: "/api/users/:userId"
        method: GET
```
- **Input:** Request with `method: "GET"`, `path: "/api/users/42"`.
- **Expected:** Error or warning: `Ambiguous match: GET /api/users/42 matches contracts "service-a" and "service-b"`. When `--service` is specified, disambiguate by service.
- **Pass criteria:** Ambiguity detected and reported. Request not silently matched to one contract.

**Test ID: MATCH-MULTI-02: Exact match wins over parameterized**

- **Manifest:**
```yaml
endpoints:
  - path: "/api/users/profile"
    method: GET
  - path: "/api/users/:id"
    method: GET
```
- **Input:** Request with `method: "GET"`, `path: "/api/users/profile"`.
- **Expected:** Matched to `/api/users/profile` (exact), not `/api/users/:id` (parameterized).
- **Pass criteria:** Exact match takes priority over parameterized.

**Test ID: MATCH-MULTI-03: Longer path match wins over shorter**

- **Manifest:**
```yaml
endpoints:
  - path: "/api/users/:id"
    method: GET
  - path: "/api/users/:id/avatar"
    method: GET
```
- **Input:** Request with `method: "GET"`, `path: "/api/users/42/avatar"`.
- **Expected:** Matched to `/api/users/:id/avatar` (more specific), not `/api/users/:id`.
- **Pass criteria:** Most specific path wins.

**Test ID: MATCH-MULTI-04: Same endpoint across multiple contracts resolved by --service**

- **Manifest:** Two contracts from different services both declaring `GET /api/users/:id`.
- **Command:** `stricture trace trace.json --service user-service`
- **Expected:** Matched to the contract owned by `user-service`.
- **Pass criteria:** `--service` flag disambiguates.

---

## 5. Field Validation

### 5.1 Required Field Checks

**Test ID: FIELD-REQ-01: All required fields present**

- **Input:** Response body: `{"id": 1, "name": "Alice", "email": "alice@example.com", "role": "admin", "created_at": "2024-01-01T00:00:00Z"}`.
- **Manifest:**
```yaml
fields:
  id:         { type: integer, required: true }
  name:       { type: string, required: true }
  email:      { type: string, required: true }
  role:       { type: enum, values: ["admin", "user", "viewer"], required: true }
  created_at: { type: string, format: iso8601, required: true }
```
- **Expected:** All required fields present. 0 violations.
- **Pass criteria:** Check mark: "All responses had required fields".

**Test ID: FIELD-REQ-02: Required field missing**

- **Input:** Response body: `{"id": 1, "name": "Alice"}`. Missing `email`, `role`, `created_at`.
- **Manifest:** Same as FIELD-REQ-01.
- **Expected:** 3 violations: `missing required field "email"`, `missing required field "role"`, `missing required field "created_at"`.
- **Pass criteria:** Each missing field listed as a separate violation.

**Test ID: FIELD-REQ-03: Required field present but null**

- **Input:** Response body: `{"id": 1, "name": null, "email": "alice@example.com", "role": "admin", "created_at": "2024-01-01T00:00:00Z"}`.
- **Manifest:** `name: { type: string, required: true }`.
- **Expected:** Violation: `required field "name" is null`.
- **Pass criteria:** `null` is not considered "present" for required fields.

**Test ID: FIELD-REQ-04: Required field present but empty string**

- **Input:** Response body: `{"id": 1, "name": "", "email": "alice@example.com", "role": "admin", "created_at": "2024-01-01T00:00:00Z"}`.
- **Manifest:** `name: { type: string, required: true }` (no `minLength` constraint).
- **Expected:** No "required field" violation. Empty string counts as present. (A separate `minLength` violation would apply if `minLength: 1` were declared.)
- **Pass criteria:** Empty string passes the "required" check.

**Test ID: FIELD-REQ-05: Nested required fields (object within object)**

- **Input:** Response body:
```json
{
  "user": {
    "id": 1,
    "profile": {
      "bio": "Hello"
    }
  }
}
```
- **Manifest:**
```yaml
fields:
  user:
    type: object
    required: true
    fields:
      id:      { type: integer, required: true }
      profile:
        type: object
        required: true
        fields:
          bio:    { type: string, required: true }
          avatar: { type: string, required: true }
```
- **Expected:** Violation: `missing required field "user.profile.avatar"`.
- **Pass criteria:** Nested field paths reported with dot notation.

**Test ID: FIELD-REQ-06: Required field present but wrong type**

- **Input:** Response body: `{"id": "not-a-number", "name": "Alice"}`.
- **Manifest:** `id: { type: integer, required: true }`.
- **Expected:** Field is present (passes required check) but type mismatch is reported as a separate violation.
- **Pass criteria:** Two concerns separated: "required" passes, "type" fails.

**Test ID: FIELD-REQ-07: Optional field missing**

- **Input:** Response body: `{"id": 1, "name": "Alice"}`.
- **Manifest:**
```yaml
fields:
  id:       { type: integer, required: true }
  name:     { type: string, required: true }
  nickname: { type: string, required: false }
```
- **Expected:** No violation. `nickname` is optional and absent.
- **Pass criteria:** Optional missing fields not flagged.

**Test ID: FIELD-REQ-08: Optional field present but invalid**

- **Input:** Response body: `{"id": 1, "name": "Alice", "nickname": 42}`.
- **Manifest:** `nickname: { type: string, required: false }`.
- **Expected:** Violation: type mismatch on `nickname` (expected string, got number). Optional fields are still validated when present.
- **Pass criteria:** Optional field presence is not required, but when present, constraints apply.

### 5.2 Range Checks

**Test ID: FIELD-RANGE-01: Value within range**

- **Input:** Response body: `{"amount": 100.50}`.
- **Manifest:** `amount: { type: number, range: [0.01, 999999.99] }`.
- **Expected:** 0 violations.
- **Pass criteria:** Value 100.50 within [0.01, 999999.99].

**Test ID: FIELD-RANGE-02: Value at minimum boundary**

- **Input:** Response body: `{"amount": 0.01}`.
- **Manifest:** `amount: { type: number, range: [0.01, 999999.99] }`.
- **Expected:** 0 violations. Minimum is inclusive.
- **Pass criteria:** Boundary value 0.01 passes.

**Test ID: FIELD-RANGE-03: Value at maximum boundary**

- **Input:** Response body: `{"amount": 999999.99}`.
- **Manifest:** `amount: { type: number, range: [0.01, 999999.99] }`.
- **Expected:** 0 violations. Maximum is inclusive.
- **Pass criteria:** Boundary value 999999.99 passes.

**Test ID: FIELD-RANGE-04: Value below minimum**

- **Input:** Response body: `{"amount": 0.001}`.
- **Manifest:** `amount: { type: number, range: [0.01, 999999.99] }`.
- **Expected:** Violation: `amount=0.001 is below minimum 0.01`.
- **Pass criteria:** Below-minimum value flagged.

**Test ID: FIELD-RANGE-05: Value above maximum**

- **Input:** Response body: `{"amount": 1000000.00}`.
- **Manifest:** `amount: { type: number, range: [0.01, 999999.99] }`.
- **Expected:** Violation: `amount=1000000.00 exceeds maximum 999999.99`.
- **Pass criteria:** Above-maximum value flagged.

**Test ID: FIELD-RANGE-06: Negative value when range starts at 0**

- **Input:** Response body: `{"count": -1}`.
- **Manifest:** `count: { type: integer, range: [0, 100] }`.
- **Expected:** Violation: `count=-1 is below minimum 0`.
- **Pass criteria:** Negative value caught by range check.

**Test ID: FIELD-RANGE-07: Float precision check**

- **Input:** Response body: `{"amount": 99.999}`.
- **Manifest:** `amount: { type: number, range: [0.01, 999999.99], precision: 2 }`.
- **Expected:** Violation: `amount=99.999 exceeds declared precision of 2 decimal places`.
- **Pass criteria:** Precision constraint enforced separately from range.

**Test ID: FIELD-RANGE-08: Integer at exact boundary values**

- **Input (a):** `{"id": 1}`.
- **Input (b):** `{"id": 2147483647}`.
- **Manifest:** `id: { type: integer, range: [1, 2147483647] }`.
- **Expected:** Both pass. Boundaries are inclusive.
- **Pass criteria:** Int32 min/max boundaries accepted.

**Test ID: FIELD-RANGE-09: Value exactly one unit outside range**

- **Input (a):** `{"id": 0}` (one below minimum of 1).
- **Input (b):** `{"id": 2147483648}` (one above maximum).
- **Manifest:** `id: { type: integer, range: [1, 2147483647] }`.
- **Expected:** Both produce violations.
- **Pass criteria:** Off-by-one boundary values caught.

### 5.3 Enum Checks

**Test ID: FIELD-ENUM-01: Value in enum list**

- **Input:** Response body: `{"role": "admin"}`.
- **Manifest:** `role: { type: enum, values: ["admin", "user", "viewer"] }`.
- **Expected:** 0 violations.
- **Pass criteria:** Value found in enum list.

**Test ID: FIELD-ENUM-02: Value not in enum list**

- **Input:** Response body: `{"role": "moderator"}`.
- **Manifest:** `role: { type: enum, values: ["admin", "user", "viewer"] }`.
- **Expected:** Violation: `role="moderator" -- not in enum [admin, user, viewer]`.
- **Pass criteria:** Non-enum value flagged. Violation message includes the allowed values.

**Test ID: FIELD-ENUM-03: Case-sensitive enum matching**

- **Input:** Response body: `{"role": "Admin"}`.
- **Manifest:** `role: { type: enum, values: ["admin", "user", "viewer"] }`.
- **Expected:** Violation: `role="Admin" -- not in enum [admin, user, viewer]`. Enum matching is case-sensitive.
- **Pass criteria:** Case mismatch detected. "Admin" != "admin".

**Test ID: FIELD-ENUM-04: Empty string when enum does not include it**

- **Input:** Response body: `{"role": ""}`.
- **Manifest:** `role: { type: enum, values: ["admin", "user", "viewer"] }`.
- **Expected:** Violation: `role="" -- not in enum [admin, user, viewer]`.
- **Pass criteria:** Empty string is not a special case; checked against enum list.

**Test ID: FIELD-ENUM-05: Multiple entries with mixed enum violations**

- **Input:** 5 responses: 3 have `role: "admin"`, 1 has `role: "moderator"`, 1 has `role: "superadmin"`.
- **Manifest:** `role: { type: enum, values: ["admin", "user", "viewer"] }`.
- **Expected:** 2 violations reported. Output groups by value: `1 response had role="moderator"`, `1 response had role="superadmin"`.
- **Pass criteria:** Violations aggregated per unique invalid value.

**Test ID: FIELD-ENUM-06: Enum with single allowed value**

- **Input:** Response body: `{"status": "active"}`.
- **Manifest:** `status: { type: enum, values: ["active"] }`.
- **Expected:** 0 violations.
- **Pass criteria:** Single-value enum works.

**Test ID: FIELD-ENUM-07: Numeric enum values**

- **Input:** Response body: `{"priority": 3}`.
- **Manifest:** `priority: { type: enum, values: [1, 2, 3, 4, 5] }`.
- **Expected:** 0 violations. Enum supports non-string values.
- **Pass criteria:** Numeric enum comparison works correctly.

### 5.4 String Constraints

**Test ID: FIELD-STR-01: String within maxLength**

- **Input:** Response body: `{"name": "Alice"}` (5 characters).
- **Manifest:** `name: { type: string, maxLength: 255 }`.
- **Expected:** 0 violations.
- **Pass criteria:** String length 5 <= 255.

**Test ID: FIELD-STR-02: String exceeding maxLength**

- **Input:** Response body: `{"name": "A"}` repeated 256 times (256 characters).
- **Manifest:** `name: { type: string, maxLength: 255 }`.
- **Expected:** Violation: `name length 256 exceeds maxLength 255`.
- **Pass criteria:** Length violation detected.

**Test ID: FIELD-STR-03: String shorter than minLength**

- **Input:** Response body: `{"name": ""}` (0 characters).
- **Manifest:** `name: { type: string, minLength: 1 }`.
- **Expected:** Violation: `name="" -- violates minLength: 1`.
- **Pass criteria:** Empty string flagged when minLength is 1.

**Test ID: FIELD-STR-04: Empty string when minLength is 1**

- **Input:** Response body: `{"name": ""}`.
- **Manifest:** `name: { type: string, minLength: 1, required: true }`.
- **Expected:** Violation for minLength (not for required -- empty string is present). Violation: `name="" -- violates minLength: 1`.
- **Pass criteria:** minLength and required are independent checks. Required passes, minLength fails.

**Test ID: FIELD-STR-05: String exactly at maxLength**

- **Input:** Response body: `{"name": "ABCDE"}` (5 characters).
- **Manifest:** `name: { type: string, maxLength: 5 }`.
- **Expected:** 0 violations. Boundary is inclusive.
- **Pass criteria:** Exact boundary passes.

**Test ID: FIELD-STR-06: String exactly at minLength**

- **Input:** Response body: `{"name": "A"}` (1 character).
- **Manifest:** `name: { type: string, minLength: 1 }`.
- **Expected:** 0 violations. Boundary is inclusive.
- **Pass criteria:** Exact boundary passes.

**Test ID: FIELD-STR-07: Unicode string length**

- **Input:** Response body: `{"name": "\u00e9\u00e8\u00ea"}` (3 Unicode characters, potentially more bytes).
- **Manifest:** `name: { type: string, maxLength: 3 }`.
- **Expected:** 0 violations. Length measured in characters, not bytes.
- **Pass criteria:** Unicode characters counted correctly (character count, not byte count).

### 5.5 Format Checks

**Test ID: FIELD-FMT-01: Valid email format**

- **Input:** Response body: `{"email": "alice@example.com"}`.
- **Manifest:** `email: { type: string, format: email }`.
- **Expected:** 0 violations.
- **Pass criteria:** Standard email passes format check.

**Test ID: FIELD-FMT-02: Invalid email format**

- **Input:** Response body: `{"email": "not-an-email"}`.
- **Manifest:** `email: { type: string, format: email }`.
- **Expected:** Violation: `email="not-an-email" -- invalid email format`.
- **Pass criteria:** Missing `@` and domain detected.

**Test ID: FIELD-FMT-03: Valid UUID format**

- **Input:** Response body: `{"invoice_id": "550e8400-e29b-41d4-a716-446655440000"}`.
- **Manifest:** `invoice_id: { type: string, format: uuid }`.
- **Expected:** 0 violations.
- **Pass criteria:** Valid v4 UUID accepted.

**Test ID: FIELD-FMT-04: Invalid UUID format**

- **Input:** Response body: `{"invoice_id": "not-a-uuid"}`.
- **Manifest:** `invoice_id: { type: string, format: uuid }`.
- **Expected:** Violation: `invoice_id="not-a-uuid" -- invalid uuid format`.
- **Pass criteria:** Non-UUID string flagged.

**Test ID: FIELD-FMT-05: Valid ISO 8601 datetime**

- **Input:** Response body: `{"created_at": "2024-06-15T14:30:00Z"}`.
- **Manifest:** `created_at: { type: string, format: iso8601 }`.
- **Expected:** 0 violations.
- **Pass criteria:** Valid ISO 8601 datetime accepted.

**Test ID: FIELD-FMT-06: Invalid ISO 8601 datetime**

- **Input:** Response body: `{"created_at": "2024-13-01"}`.
- **Manifest:** `created_at: { type: string, format: iso8601 }`.
- **Expected:** Violation: `created_at="2024-13-01" -- invalid iso8601 format (month 13)`.
- **Pass criteria:** Invalid date component detected.

**Test ID: FIELD-FMT-07: Unknown format**

- **Input:** Response body: `{"code": "ABC-123"}`.
- **Manifest:** `code: { type: string, format: custom-code }`.
- **Expected:** Warning: `Unknown format "custom-code" for field "code" -- skipping format validation`. No violation.
- **Pass criteria:** Unknown format produces a warning, not a violation or error.

**Test ID: FIELD-FMT-08: Email edge cases**

- **Input (a):** `{"email": "user+tag@example.com"}` (plus addressing).
- **Input (b):** `{"email": "user@sub.domain.example.com"}` (subdomain).
- **Input (c):** `{"email": "@example.com"}` (missing local part).
- **Input (d):** `{"email": "user@"}` (missing domain).
- **Expected (a):** Pass. (b): Pass. (c): Violation. (d): Violation.
- **Pass criteria:** Valid edge cases accepted, invalid ones rejected.

**Test ID: FIELD-FMT-09: UUID case sensitivity**

- **Input:** Response body: `{"invoice_id": "550E8400-E29B-41D4-A716-446655440000"}` (uppercase).
- **Manifest:** `invoice_id: { type: string, format: uuid }`.
- **Expected:** 0 violations. UUID hex digits are case-insensitive per RFC 4122.
- **Pass criteria:** Uppercase UUID accepted.

**Test ID: FIELD-FMT-10: ISO 8601 variations**

- **Input (a):** `{"ts": "2024-06-15T14:30:00Z"}` (UTC with Z).
- **Input (b):** `{"ts": "2024-06-15T14:30:00+05:30"}` (with timezone offset).
- **Input (c):** `{"ts": "2024-06-15T14:30:00.123Z"}` (with milliseconds).
- **Input (d):** `{"ts": "2024-06-15"}` (date only).
- **Manifest:** `ts: { type: string, format: iso8601 }`.
- **Expected:** All four should pass as valid ISO 8601.
- **Pass criteria:** All standard ISO 8601 variations accepted.

### 5.6 Status Code Checks

**Test ID: FIELD-STATUS-01: Status code in declared set**

- **Input:** Response with status 200.
- **Manifest:** `status_codes: [200, 400, 404, 500]`.
- **Expected:** 0 violations.
- **Pass criteria:** Status code found in declared set.

**Test ID: FIELD-STATUS-02: Status code not in declared set**

- **Input:** Response with status 503.
- **Manifest:** `status_codes: [200, 400, 404, 500]`.
- **Expected:** Warning: `status 503 -- not in declared status_codes [200, 400, 404, 500]`.
- **Pass criteria:** Undeclared status code produces a warning (not an error by default).

**Test ID: FIELD-STATUS-03: 503 when only common codes declared**

- **Input:** 12 responses with status 503.
- **Manifest:** `status_codes: [200, 400, 404, 500]`.
- **Expected:** Warning aggregated: `12 responses had status 503 -- not in declared status_codes [200, 400, 404, 500]`.
- **Pass criteria:** Warning aggregated by status code. Count shown.

**Test ID: FIELD-STATUS-04: Unexpected 2xx codes**

- **Input:** Response with status 201.
- **Manifest:** `status_codes: [200, 400, 500]` (201 not declared).
- **Expected:** Warning: `status 201 -- not in declared status_codes [200, 400, 500]`.
- **Pass criteria:** Even success codes are flagged if undeclared.

**Test ID: FIELD-STATUS-05: 0 status (connection failure)**

- **Input:** Response with status 0.
- **Manifest:** `status_codes: [200, 400, 500]`.
- **Expected:** Special handling: not a status code violation. Reported separately as "connection failure". Warning: `1 request had status 0 (connection failure)`.
- **Pass criteria:** Status 0 not counted as a status code mismatch. Handled as a distinct failure category.

**Test ID: FIELD-STATUS-06: All declared status codes observed**

- **Input:** 10 responses: 7 with status 200, 1 with 400, 1 with 404, 1 with 500.
- **Manifest:** `status_codes: [200, 400, 404, 500]`.
- **Expected:** 0 warnings. All observed codes are in the declared set.
- **Pass criteria:** Clean pass when all responses use declared codes.

**Test ID: FIELD-STATUS-07: Multiple undeclared status codes**

- **Input:** Responses with status 502, 503, and 504.
- **Manifest:** `status_codes: [200, 400, 500]`.
- **Expected:** Three separate warnings, one per undeclared code.
- **Pass criteria:** Each undeclared code reported individually.

**Test ID: FIELD-STATUS-08: Status code validation with --strict flag**

- **Input:** Response with status 503.
- **Manifest:** `status_codes: [200, 400, 500]`.
- **Command:** `stricture trace trace.har --strict`
- **Expected:** Status code warning elevated to violation. Exit code 1.
- **Pass criteria:** `--strict` makes status code deviations failures.

### 5.7 Type Checks

**Test ID: FIELD-TYPE-01: Expected integer, got string**

- **Input:** Response body: `{"id": "abc"}`.
- **Manifest:** `id: { type: integer, required: true }`.
- **Expected:** Violation: `id: expected integer, got string "abc"`.
- **Pass criteria:** Type mismatch detected.

**Test ID: FIELD-TYPE-02: Expected string, got number**

- **Input:** Response body: `{"name": 42}`.
- **Manifest:** `name: { type: string, required: true }`.
- **Expected:** Violation: `name: expected string, got number 42`.
- **Pass criteria:** Type mismatch detected.

**Test ID: FIELD-TYPE-03: Expected boolean, got string "true" (strict)**

- **Input:** Response body: `{"active": "true"}`.
- **Manifest:** `active: { type: boolean }`.
- **Expected (default):** Violation: `active: expected boolean, got string "true"`.
- **Pass criteria:** Strict type checking by default. String "true" is not boolean `true`.

**Test ID: FIELD-TYPE-04: Expected array, got object**

- **Input:** Response body: `{"items": {"key": "value"}}`.
- **Manifest:** `items: { type: array }`.
- **Expected:** Violation: `items: expected array, got object`.
- **Pass criteria:** Array vs object mismatch detected.

**Test ID: FIELD-TYPE-05: Expected object, got null (required field)**

- **Input:** Response body: `{"profile": null}`.
- **Manifest:** `profile: { type: object, required: true }`.
- **Expected:** Violation: `profile: required field is null`.
- **Pass criteria:** Null is not a valid object for required fields.

**Test ID: FIELD-TYPE-06: Expected number, got integer**

- **Input:** Response body: `{"amount": 42}` (integer, no decimal).
- **Manifest:** `amount: { type: number }`.
- **Expected:** 0 violations. Integer is a valid number.
- **Pass criteria:** Integer accepted where number is expected (number is a superset of integer).

**Test ID: FIELD-TYPE-07: Expected integer, got float**

- **Input:** Response body: `{"count": 3.5}`.
- **Manifest:** `count: { type: integer }`.
- **Expected:** Violation: `count: expected integer, got float 3.5`.
- **Pass criteria:** Float not accepted where integer is expected.

**Test ID: FIELD-TYPE-08: Null value for optional field**

- **Input:** Response body: `{"nickname": null}`.
- **Manifest:** `nickname: { type: string, required: false }`.
- **Expected:** 0 violations. Optional field may be null.
- **Pass criteria:** Null accepted for optional fields.

**Test ID: FIELD-TYPE-09: Array element type validation**

- **Input:** Response body: `{"ids": [1, 2, "three", 4]}`.
- **Manifest:** `ids: { type: array, items: { type: integer } }`.
- **Expected:** Violation: `ids[2]: expected integer, got string "three"`.
- **Pass criteria:** Array element types validated. Index reported in violation path.

**Test ID: FIELD-TYPE-10: Deeply nested type mismatch**

- **Input:** Response body: `{"data": {"user": {"settings": {"theme": 42}}}}`.
- **Manifest:** Nested field `data.user.settings.theme: { type: string }`.
- **Expected:** Violation: `data.user.settings.theme: expected string, got number 42`.
- **Pass criteria:** Full dot-notation path in violation message.

---

## 6. Trace Output

### 6.1 Summary Statistics

**Test ID: OUTPUT-SUMMARY-01: All statistics present**

- **Input:** 247 requests: 190 matched (6 violations), 57 unmatched.
- **Expected output:**
```
Trace Audit -- 247 requests matched to contracts
================================================

...per-contract details...

Summary: 190 matched, 6 violations, 57 unmatched
```
- **Pass criteria:** Total requests, matched count, violation count, and unmatched count all present in summary.

**Test ID: OUTPUT-SUMMARY-02: Grouping by contract and endpoint**

- **Input:** 200 requests: 142 to `GET /api/users/:id`, 48 to `POST /api/users`, 10 unmatched.
- **Expected output structure:**
```
Contract: user-api
  GET /api/users/:id (142 requests)
    ...violations or checkmarks...
  POST /api/users (48 requests)
    ...violations or checkmarks...
```
- **Pass criteria:** Results grouped by contract ID, then by endpoint within each contract.

**Test ID: OUTPUT-SUMMARY-03: Zero violations**

- **Input:** 50 requests, all valid, all matched.
- **Expected:** Summary: `50 matched, 0 violations, 0 unmatched`. All endpoints show checkmarks.
- **Pass criteria:** Clean output with no violation lines.

**Test ID: OUTPUT-SUMMARY-04: Zero matched requests**

- **Input:** 20 requests, none matching any contract.
- **Expected:** Summary: `0 matched, 0 violations, 20 unmatched`.
- **Pass criteria:** No "Contract:" sections. Only "Unmatched requests" section.

**Test ID: OUTPUT-SUMMARY-05: Mixed violations across contracts**

- **Input:** Requests spanning 3 contracts. Violations in 2 of them.
- **Expected:** Each contract section shows its own violations. Summary totals across all contracts.
- **Pass criteria:** Violations attributed to the correct contract and endpoint.

### 6.2 Output Formats

**Test ID: OUTPUT-FMT-01: Text format (human-readable)**

- **Command:** `stricture trace trace.har` (default text output).
- **Expected:** Unicode check/cross/warning symbols. Indented hierarchy. Human-readable summary.
- **Pass criteria:** Output uses checkmark, cross mark, and warning triangle symbols. Readable without parsing.

**Test ID: OUTPUT-FMT-02: JSON output format**

- **Command:** `stricture trace trace.har --format json`
- **Expected:** Valid JSON output:
```json
{
  "total_requests": 247,
  "matched": 190,
  "violations": 6,
  "unmatched": 57,
  "contracts": [
    {
      "id": "user-api",
      "endpoints": [
        {
          "path": "/api/users/:id",
          "method": "GET",
          "request_count": 142,
          "violations": [
            {
              "field": "role",
              "type": "enum_violation",
              "actual_value": "moderator",
              "allowed_values": ["admin", "user", "viewer"],
              "occurrence_count": 3
            }
          ]
        }
      ]
    }
  ],
  "unmatched_requests": [
    { "method": "GET", "path": "/healthz", "count": 30 }
  ]
}
```
- **Pass criteria:** Valid JSON. All fields present. Parseable by `jq`.

**Test ID: OUTPUT-FMT-03: SARIF output format**

- **Command:** `stricture trace trace.har --format sarif`
- **Expected:** Valid SARIF v2.1.0 JSON. Each violation is a `result` with `ruleId`, `message`, `locations` (endpoint path), `level` (error or warning).
- **Pass criteria:** SARIF validates against schema. Compatible with GitHub Code Scanning and VS Code SARIF viewer.

**Test ID: OUTPUT-FMT-04: JSON output is stable (deterministic)**

- **Input:** Same trace file run twice.
- **Expected:** Identical JSON output both times (same key ordering, same grouping).
- **Pass criteria:** `diff` of two runs produces no differences.

### 6.3 Strict Mode

**Test ID: OUTPUT-STRICT-01: --strict with violations exits code 1**

- **Input:** Trace with 3 enum violations.
- **Command:** `stricture trace trace.har --strict`
- **Expected:** Exit code 1. Violations reported as errors.
- **Pass criteria:** Exit code is 1, not 0.

**Test ID: OUTPUT-STRICT-02: --strict with no violations exits code 0**

- **Input:** Trace with 0 violations.
- **Command:** `stricture trace trace.har --strict`
- **Expected:** Exit code 0.
- **Pass criteria:** Clean trace passes even in strict mode.

**Test ID: OUTPUT-STRICT-03: Without --strict, violations are warnings (exit 0)**

- **Input:** Trace with 3 enum violations.
- **Command:** `stricture trace trace.har` (no `--strict`).
- **Expected:** Exit code 0. Violations reported as warnings.
- **Pass criteria:** Exit code 0 despite violations.

**Test ID: OUTPUT-STRICT-04: --strict elevates status code warnings to errors**

- **Input:** Response with undeclared status code 503.
- **Command:** `stricture trace trace.har --strict`
- **Expected:** Status code deviation treated as an error. Exit code 1.
- **Pass criteria:** `--strict` applies to all deviation types, including status codes.

**Test ID: OUTPUT-STRICT-05: --strict with unmatched requests**

- **Input:** 10 matched (0 violations), 5 unmatched.
- **Command:** `stricture trace trace.har --strict`
- **Expected:** Exit code 0. Unmatched requests are informational, not violations, even in strict mode.
- **Pass criteria:** Unmatched requests alone do not cause exit code 1.

---

## 7. Protocol Coverage

### 7.1 HTTP Protocol

**Test ID: PROTO-HTTP-01: All HTTP methods**

- **Input:** Trace with requests using GET, POST, PUT, DELETE, PATCH, HEAD, and OPTIONS.
- **Manifest:** Endpoints for each method.
- **Expected:** All 7 matched to their respective endpoints.
- **Pass criteria:** Every standard HTTP method handled.

**Test ID: PROTO-HTTP-02: Content-Type application/json**

- **Input:** POST request with `Content-Type: application/json`. Body is valid JSON.
- **Manifest:** POST endpoint with request field constraints.
- **Expected:** Body parsed as JSON, fields validated.
- **Pass criteria:** JSON content type triggers body field validation.

**Test ID: PROTO-HTTP-03: Content-Type multipart/form-data**

- **Input:** POST request with `Content-Type: multipart/form-data`. Body contains named fields.
- **Manifest:** POST endpoint with request field constraints matching form fields.
- **Expected:** Form fields extracted and validated against manifest.
- **Pass criteria:** Multipart form data fields mapped to manifest field names.

**Test ID: PROTO-HTTP-04: Content-Type application/x-www-form-urlencoded**

- **Input:** POST request with `Content-Type: application/x-www-form-urlencoded`. Body: `name=Alice&email=alice%40example.com`.
- **Manifest:** POST endpoint with `name` and `email` fields.
- **Expected:** URL-encoded body parsed, fields extracted, validated.
- **Pass criteria:** URL-encoded values decoded and matched to manifest fields.

**Test ID: PROTO-HTTP-05: Request headers validation**

- **Input:** Request with `Authorization: Bearer token123`, `X-Request-ID: abc-def`.
- **Manifest:** Endpoint with required headers: `Authorization` (present), `X-Custom-Header` (absent).
- **Expected:** Warning: `missing required header "X-Custom-Header"`. Authorization header presence validated.
- **Pass criteria:** Required headers checked if manifest specifies them.

**Test ID: PROTO-HTTP-06: Response headers validation**

- **Input:** Response with `Content-Type: application/json`, `Cache-Control: no-store`.
- **Manifest:** Endpoint declares expected response headers.
- **Expected:** Response headers validated against manifest declarations.
- **Pass criteria:** Response header presence/value checked.

### 7.2 Message Queue Protocol

**Test ID: PROTO-MQ-01: Event name matching**

- **Input:** Custom JSON trace with message queue events:
```json
[
  { "event": "invoice.created", "body": {"invoice_id": "550e8400-e29b-41d4-a716-446655440000", "user_id": 1, "amount": 100.00, "currency": "USD"} }
]
```
- **Manifest:**
```yaml
contracts:
  - id: "billing-events"
    protocol: message_queue
    messages:
      - event: "invoice.created"
        fields:
          invoice_id: { type: string, format: uuid, required: true }
          user_id:    { type: integer, range: [1, 2147483647], required: true }
          amount:     { type: number, range: [0.01, 999999.99], precision: 2, required: true }
          currency:   { type: enum, values: ["USD", "EUR", "GBP"], required: true }
```
- **Expected:** Event matched to `invoice.created` message contract. All fields validated. 0 violations.
- **Pass criteria:** Message queue events matched by event name, fields validated.

**Test ID: PROTO-MQ-02: Message body field validation**

- **Input:** Event `invoice.created` with `amount: -5.00` (below range minimum).
- **Manifest:** `amount: { type: number, range: [0.01, 999999.99] }`.
- **Expected:** Violation: `amount=-5.00 is below minimum 0.01`.
- **Pass criteria:** Message body fields validated with same rules as HTTP response fields.

**Test ID: PROTO-MQ-03: Multiple events in same trace**

- **Input:** 5 `invoice.created` events and 3 `invoice.paid` events.
- **Manifest:** Message contracts for both event types.
- **Expected:** 8 total matched. Violations grouped by event type.
- **Pass criteria:** Multiple event types handled in a single trace.

**Test ID: PROTO-MQ-04: Out-of-order events**

- **Input:** Events in non-chronological order (timestamps out of sequence).
- **Manifest:** Message contracts.
- **Expected:** Each event validated independently. Order does not affect validation.
- **Pass criteria:** No ordering dependency for validation.

**Test ID: PROTO-MQ-05: Unrecognized event name**

- **Input:** Event `order.shipped` not declared in manifest.
- **Manifest:** Only `invoice.created` and `invoice.paid` declared.
- **Expected:** `order.shipped` reported as unmatched.
- **Pass criteria:** Unmatched events reported like unmatched HTTP requests.

### 7.3 Future Protocols (Documented but Not Implemented)

**Test ID: PROTO-FUTURE-01: gRPC trace input**

- **Input:** Trace file containing gRPC/protobuf messages.
- **Expected:** Clear error: `gRPC trace validation is not yet supported. See roadmap.`
- **Pass criteria:** Not a crash. Actionable error message with roadmap reference.

**Test ID: PROTO-FUTURE-02: WebSocket trace input**

- **Input:** Trace file containing WebSocket frame data.
- **Expected:** Clear error: `WebSocket trace validation is not yet supported. See roadmap.`
- **Pass criteria:** Graceful rejection.

**Test ID: PROTO-FUTURE-03: GraphQL trace input**

- **Input:** Trace file containing GraphQL queries/mutations/subscriptions.
- **Expected:** Clear error: `GraphQL trace validation is not yet supported. See roadmap.`
- **Pass criteria:** Graceful rejection.

---

## 8. CLI Flags and Configuration

### 8.1 --manifest Flag

**Test ID: CLI-MANIFEST-01: Explicit manifest path**

- **Command:** `stricture trace trace.har --manifest /path/to/manifest.yml`
- **Expected:** Manifest loaded from specified path.
- **Pass criteria:** Uses the provided path, not auto-detection.

**Test ID: CLI-MANIFEST-02: Manifest auto-detection**

- **Setup:** `stricture-manifest.yml` exists in a parent directory or configured path.
- **Command:** `stricture trace trace.har` (no `--manifest` flag).
- **Expected:** Manifest found by auto-detection. Processing continues.
- **Pass criteria:** Auto-detection finds manifest without explicit flag.

**Test ID: CLI-MANIFEST-03: Manifest not found**

- **Command:** `stricture trace trace.har --manifest /nonexistent/manifest.yml`
- **Expected:** Exit code 2. Error: `Manifest not found: /nonexistent/manifest.yml`.
- **Pass criteria:** Clear error about missing manifest.

**Test ID: CLI-MANIFEST-04: Manifest with invalid YAML**

- **Input:** Manifest file with YAML syntax error.
- **Expected:** Exit code 2. Error: `Manifest parse error: invalid YAML at line N`.
- **Pass criteria:** YAML error with line number.

### 8.2 --trace-format Flag

**Test ID: CLI-FORMAT-01: Auto-detect HAR**

- **Command:** `stricture trace capture.har`
- **Expected:** Format auto-detected as HAR (by `.har` extension and/or `log.entries` structure).
- **Pass criteria:** No `--trace-format` needed for HAR files.

**Test ID: CLI-FORMAT-02: Auto-detect OTel**

- **Command:** `stricture trace trace.json` (file contains `resourceSpans`).
- **Expected:** Format auto-detected as OTel (by `resourceSpans` key in JSON).
- **Pass criteria:** OTel JSON detected without explicit flag.

**Test ID: CLI-FORMAT-03: Explicit format override**

- **Command:** `stricture trace data.json --trace-format custom`
- **Expected:** File parsed as custom JSON format regardless of content structure.
- **Pass criteria:** Explicit format takes precedence over auto-detection.

**Test ID: CLI-FORMAT-04: Wrong format specified**

- **Command:** `stricture trace trace.har --trace-format otel` (HAR file with OTel format specified).
- **Expected:** Exit code 2. Error: `Parse error: file does not match specified format "otel"`.
- **Pass criteria:** Format mismatch detected and reported.

**Test ID: CLI-FORMAT-05: Ambiguous auto-detection**

- **Input:** JSON file that could be either OTel or custom (e.g., has `resourceSpans` but also looks like an array).
- **Expected:** If ambiguous, prompt user to specify `--trace-format`. Or apply heuristic (prefer OTel if `resourceSpans` key present).
- **Pass criteria:** Consistent behavior. No silent misparse.

### 8.3 --service Flag

**Test ID: CLI-SERVICE-01: Filter by service name**

- **Command:** `stricture trace trace.json --service user-service`
- **Manifest:** Multiple services declared.
- **Expected:** Only contracts for `user-service` considered. Other service endpoints ignored.
- **Pass criteria:** Summary only includes user-service endpoints.

**Test ID: CLI-SERVICE-02: Unknown service name**

- **Command:** `stricture trace trace.json --service nonexistent-service`
- **Manifest:** No service named `nonexistent-service`.
- **Expected:** Exit code 2. Error: `Service "nonexistent-service" not found in manifest`.
- **Pass criteria:** Service validated against manifest.

**Test ID: CLI-SERVICE-03: Service filters OTel spans**

- **Command:** `stricture trace otel.json --service billing-service`
- **Input:** OTel trace with spans from 3 services.
- **Expected:** Only spans with `service.name: "billing-service"` processed.
- **Pass criteria:** OTel service filtering uses `resource.attributes.service.name`.

### 8.4 --strict Flag

See OUTPUT-STRICT-01 through OUTPUT-STRICT-05 in section 6.3.

### 8.5 Exit Codes

**Test ID: CLI-EXIT-01: Exit 0 -- no violations**

- **Input:** Valid trace, all matched, all fields valid.
- **Expected:** Exit code 0.

**Test ID: CLI-EXIT-02: Exit 0 -- violations but no --strict**

- **Input:** Trace with violations. No `--strict` flag.
- **Expected:** Exit code 0.

**Test ID: CLI-EXIT-03: Exit 1 -- violations with --strict**

- **Input:** Trace with violations. `--strict` flag set.
- **Expected:** Exit code 1.

**Test ID: CLI-EXIT-04: Exit 2 -- configuration error**

- **Input:** Invalid manifest YAML.
- **Expected:** Exit code 2.

**Test ID: CLI-EXIT-05: Exit 2 -- parse error**

- **Input:** Trace file that is not valid JSON.
- **Expected:** Exit code 2.

**Test ID: CLI-EXIT-06: Exit 2 -- file not found**

- **Command:** `stricture trace nonexistent-file.har`
- **Expected:** Exit code 2. Error: `File not found: nonexistent-file.har`.

---

## 9. Format Auto-Detection

### 9.1 Detection by Content

**Test ID: DETECT-01: HAR detected by log.entries**

- **Input:** JSON file with `{"log": {"entries": [...]}}`.
- **Expected:** Auto-detected as HAR.
- **Pass criteria:** HAR parser used.

**Test ID: DETECT-02: OTel detected by resourceSpans**

- **Input:** JSON file with `{"resourceSpans": [...]}`.
- **Expected:** Auto-detected as OTel.
- **Pass criteria:** OTel parser used.

**Test ID: DETECT-03: Custom detected by array of objects**

- **Input:** JSON file with `[{"method": "GET", "path": "/api/users", "status": 200}]`.
- **Expected:** Auto-detected as custom format.
- **Pass criteria:** Custom parser used.

**Test ID: DETECT-04: Detection by file extension**

- **Input (a):** File named `traffic.har` containing valid HAR.
- **Input (b):** File named `trace.otlp.json` containing OTel JSON.
- **Expected (a):** HAR. (b): Attempt OTel, fall back to content-based detection.
- **Pass criteria:** Extension used as a hint but content validated.

**Test ID: DETECT-05: Non-JSON file**

- **Input:** XML file, CSV file, plain text file.
- **Expected:** Exit code 2. Error specifies that only JSON-based trace formats are supported.
- **Pass criteria:** Clear error about unsupported format.

---

## 10. Request Body Validation

### 10.1 Request Fields Against Manifest

**Test ID: REQBODY-01: All required request fields present**

- **Input:** POST request body: `{"name": "Alice", "email": "alice@example.com", "role": "admin"}`.
- **Manifest:**
```yaml
request:
  fields:
    name:  { type: string, minLength: 1, maxLength: 255, required: true }
    email: { type: string, format: email, required: true }
    role:  { type: enum, values: ["admin", "user", "viewer"], required: true }
```
- **Expected:** 0 violations.
- **Pass criteria:** All request fields validated against manifest request contract.

**Test ID: REQBODY-02: Required request field missing**

- **Input:** POST request body: `{"name": "Alice"}`. Missing `email` and `role`.
- **Manifest:** Same as REQBODY-01.
- **Expected:** 2 violations: missing `email`, missing `role`.
- **Pass criteria:** Missing request fields flagged same as response fields.

**Test ID: REQBODY-03: Request field constraint violation**

- **Input:** POST request body: `{"name": "Alice", "email": "not-an-email", "role": "mod"}`.
- **Manifest:** Same as REQBODY-01.
- **Expected:** 2 violations: `email` format invalid, `role` not in enum.
- **Pass criteria:** Request body constraints enforced.

**Test ID: REQBODY-04: GET request -- no body validation**

- **Input:** GET request (no body).
- **Manifest:** GET endpoint with only response fields declared.
- **Expected:** No request body validation attempted.
- **Pass criteria:** No "missing request body" error for GET.

**Test ID: REQBODY-05: Request body is not JSON**

- **Input:** POST request with `Content-Type: text/plain`, body: `Hello world`.
- **Manifest:** POST endpoint with JSON request fields.
- **Expected:** Warning: `Cannot validate request body: Content-Type is text/plain, expected application/json`. Body validation skipped.
- **Pass criteria:** Non-JSON request bodies produce a warning, not an error.

---

## 11. Multi-Contract Traces

### 11.1 Trace Spanning Multiple Contracts

**Test ID: MULTI-01: Trace with requests to multiple contracts**

- **Input:** 100 requests: 60 to `user-api` endpoints, 40 to `billing-api` endpoints.
- **Manifest:**
```yaml
contracts:
  - id: "user-api"
    endpoints:
      - path: "/api/users/:id"
        method: GET
  - id: "billing-api"
    endpoints:
      - path: "/api/invoices/:id"
        method: GET
```
- **Expected:** Results grouped by contract:
```
Contract: user-api
  GET /api/users/:id (60 requests)
    ...

Contract: billing-api
  GET /api/invoices/:id (40 requests)
    ...
```
- **Pass criteria:** Each contract section reported independently.

**Test ID: MULTI-02: Violations isolated per contract**

- **Input:** `user-api` has 3 violations, `billing-api` has 0 violations.
- **Expected:** Violations only appear under `user-api`. `billing-api` shows all checkmarks.
- **Pass criteria:** No cross-contamination of violations between contracts.

**Test ID: MULTI-03: Contract with zero matched requests**

- **Input:** All requests match `user-api`. No requests match `billing-api`.
- **Expected:** `billing-api` section either omitted or shows "(0 requests)".
- **Pass criteria:** Contracts with no matching traffic handled gracefully.

---

## 12. Error Handling and Resilience

### 12.1 File System Errors

**Test ID: ERR-FS-01: Trace file not found**

- **Command:** `stricture trace /nonexistent/path/trace.har`
- **Expected:** Exit code 2. Error: `File not found: /nonexistent/path/trace.har`.
- **Pass criteria:** Clear error with file path.

**Test ID: ERR-FS-02: Trace file not readable (permissions)**

- **Setup:** Trace file with `chmod 000`.
- **Expected:** Exit code 2. Error: `Permission denied: trace.har`.
- **Pass criteria:** Permission error reported.

**Test ID: ERR-FS-03: Trace file is a directory**

- **Command:** `stricture trace ./some-directory/`
- **Expected:** Exit code 2. Error: `Not a file: ./some-directory/`.
- **Pass criteria:** Directory rejected.

**Test ID: ERR-FS-04: Empty trace file**

- **Input:** 0-byte file.
- **Expected:** Exit code 2. Error: `Parse error: trace file is empty`.
- **Pass criteria:** Empty file not silently accepted.

### 12.2 Manifest Errors

**Test ID: ERR-MANIFEST-01: Manifest missing contracts section**

- **Input:** Manifest with services but no `contracts:` section.
- **Expected:** Exit code 2. Error: `Manifest has no contracts defined`.
- **Pass criteria:** Missing contracts section caught.

**Test ID: ERR-MANIFEST-02: Contract missing endpoints**

- **Input:** Contract with `id` and `producer` but no `endpoints:` array.
- **Expected:** Warning: `Contract "user-api" has no endpoints defined`. Processing continues for other contracts.
- **Pass criteria:** Malformed contract does not crash processing.

**Test ID: ERR-MANIFEST-03: Manifest version incompatibility**

- **Input:** Manifest with `manifest_version: "2.0"` (unsupported).
- **Expected:** Exit code 2. Error: `Unsupported manifest version "2.0". Supported: "1.0"`.
- **Pass criteria:** Version check prevents silent misinterpretation.

### 12.3 Partial Failures

**Test ID: ERR-PARTIAL-01: Some entries unparseable in HAR**

- **Input:** HAR with 10 entries: 8 valid, 2 with malformed JSON bodies.
- **Expected:** 8 entries processed. 2 entries skipped with warnings: `Entry 4: skipped (malformed response body)`. Summary reflects 8 matched.
- **Pass criteria:** Valid entries still processed despite some failures.

**Test ID: ERR-PARTIAL-02: Mixed valid and invalid custom JSON entries**

- **Input:** Array of 5 entries: 3 valid, 1 missing `method`, 1 missing `path`.
- **Expected:** 3 processed, 2 skipped with individual warnings.
- **Pass criteria:** Partial processing with clear skip reasons.

---

## 13. Aggregation and Deduplication

### 13.1 Violation Aggregation

**Test ID: AGG-01: Same violation across multiple requests**

- **Input:** 142 requests to `GET /api/users/:id`. 3 of them have `role="moderator"`.
- **Expected output:** `3 responses had role="moderator" -- not in enum [admin, user, viewer]`. (Not 3 separate violation entries.)
- **Pass criteria:** Violations aggregated by type+field+value, with occurrence count.

**Test ID: AGG-02: Different violations on same field**

- **Input:** 5 responses: 3 have `role="moderator"`, 2 have `role="superadmin"`.
- **Expected:** Two violation lines:
```
3 responses had role="moderator" -- not in enum [admin, user, viewer]
2 responses had role="superadmin" -- not in enum [admin, user, viewer]
```
- **Pass criteria:** Distinct invalid values reported separately.

**Test ID: AGG-03: Violations on different fields**

- **Input:** 1 response with `role="moderator"` and `name=""`.
- **Manifest:** `role: enum`, `name: minLength: 1`.
- **Expected:** Two violations on the same response, reported as separate items.
- **Pass criteria:** Multiple field violations from the same response reported individually.

**Test ID: AGG-04: All responses pass for an endpoint**

- **Input:** 100 requests to `GET /api/users/:id`, all with valid fields.
- **Expected:** `All responses had required fields`. Checkmark prefix.
- **Pass criteria:** Clean pass message for fully-compliant endpoints.

---

## 14. Interaction with stricture audit and stricture lint

### 14.1 Complementary Validation

**Test ID: CHAIN-01: Trace catches runtime issue that audit/lint cannot**

- **Scenario:** Manifest declares `role: enum [admin, user, viewer]`. Code correctly validates the enum. But a database migration added `role="moderator"` to legacy records. API returns these values.
- **Input:** Trace showing `role="moderator"` in responses.
- **Expected:** `stricture trace` catches the violation. `stricture audit` and `stricture lint` would show no issues (code is correct).
- **Pass criteria:** Trace validation finds runtime deviations that static analysis cannot.

**Test ID: CHAIN-02: Audit catches code issue that trace misses**

- **Scenario:** Code does not validate the `amount` range, but all actual traffic happens to be within range.
- **Expected:** `stricture audit` flags missing validation. `stricture trace` shows 0 violations (all traffic is valid).
- **Pass criteria:** Audit and trace are complementary, not redundant.

---

## 15. Performance and Scalability

### 15.1 Large Trace Files

**Test ID: PERF-01: 1,000 request trace file**

- **Input:** HAR with 1,000 entries.
- **Expected:** Completes in under 5 seconds.
- **Pass criteria:** No timeout. No memory warnings.

**Test ID: PERF-02: 10,000 request trace file**

- **Input:** HAR with 10,000 entries, each with ~1KB response body.
- **Expected:** Completes in under 30 seconds.
- **Pass criteria:** Linear or sub-linear scaling.

**Test ID: PERF-03: 100,000 span OTel trace**

- **Input:** OTel JSON with 100,000 spans.
- **Expected:** Completes. Memory under 500MB.
- **Pass criteria:** Handles production-scale traces.

**Test ID: PERF-04: Single large response body (10MB)**

- **Input:** One HAR entry with a 10MB JSON response body (deeply nested object).
- **Expected:** Parsed and validated. May be slow but completes.
- **Pass criteria:** No crash. Validation correct.

### 15.2 Manifest Complexity

**Test ID: PERF-05: Manifest with 50 contracts and 500 endpoints**

- **Input:** Trace with 1,000 requests against 500 possible endpoints.
- **Expected:** Matching completes efficiently. No O(n*m) worst case on every request.
- **Pass criteria:** Matching is efficient (ideally indexed by path prefix or trie).

---

## 16. Regression Tests

### 16.1 Product Spec Example

**Test ID: REGRESS-01: Reproduce exact example from product spec**

- **Input:** Trace file producing the exact output shown in product spec section 13.8:
  - Contract: `user-api`
  - `GET /api/users/:id` -- 142 requests, 3 with `role="moderator"`, 1 with `name=""`, 12 with status 503.
  - `POST /api/users` -- 48 requests, 2 with `role="mod"`.
  - 57 unmatched: 30 `/healthz`, 27 `/metrics`.
- **Expected output matches spec:**
```
Trace Audit -- 247 requests matched to contracts
====================================================

Contract: user-api
  GET /api/users/:id (142 requests)
    checkmark All responses had required fields
    cross 3 responses had role="moderator" -- not in enum [admin, user, viewer]
    cross 1 response had name="" -- violates minLength: 1
    warning 12 responses had status 503 -- not in declared status_codes [200, 400, 404, 500]

  POST /api/users (48 requests)
    checkmark All requests had required fields
    cross 2 requests sent role="mod" -- not in enum
    checkmark All responses matched declared shape

Unmatched requests: 57 (no manifest contract)
  GET /healthz (30)
  GET /metrics (27)

Summary: 190 matched, 6 violations, 57 unmatched
```
- **Pass criteria:** Output matches the product spec example exactly (modulo Unicode symbol rendering).

### 16.2 Golden File Tests

**Test ID: REGRESS-02: Golden file for text output**

- **Input:** Fixed trace file and manifest (committed to repo).
- **Expected:** Text output matches golden file byte-for-byte.
- **Pass criteria:** `diff` against golden file produces no output.

**Test ID: REGRESS-03: Golden file for JSON output**

- **Input:** Same fixed trace file and manifest.
- **Expected:** JSON output matches golden file (after JSON normalization).
- **Pass criteria:** JSON-equal comparison passes.

**Test ID: REGRESS-04: Golden file for SARIF output**

- **Input:** Same fixed trace file and manifest.
- **Expected:** SARIF output matches golden file.
- **Pass criteria:** SARIF schema validation passes. Content matches golden file.
