# validation-set.yml â€” Focused validation-set regression workflow (Go-only).
name: Validation Set Regression

on:
  push:
    paths:
      - "cmd/**"
      - "internal/**"
      - "docs/test-plan/validation-set/**"
      - "docs/error-catalog.yml"
      - "docs/RULE-INDEX.md"
      - "scripts/run-validation-set.sh"
      - "scripts/validation-health-check.sh"
      - "scripts/check-rule-consistency.sh"
      - ".github/workflows/validation-set.yml"
  pull_request:
    paths:
      - "cmd/**"
      - "internal/**"
      - "docs/test-plan/validation-set/**"
      - "docs/error-catalog.yml"
      - "docs/RULE-INDEX.md"
      - "scripts/run-validation-set.sh"
      - "scripts/validation-health-check.sh"
      - "scripts/check-rule-consistency.sh"
      - ".github/workflows/validation-set.yml"

concurrency:
  group: validation-${{ github.ref }}
  cancel-in-progress: true

env:
  GO_VERSION: "1.22"

jobs:
  rule-consistency:
    name: Rule Consistency
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check rule consistency
        run: ./scripts/check-rule-consistency.sh

  health-check:
    name: Validation Set Health Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run health check
        run: ./scripts/validation-health-check.sh

  validation-set:
    name: Validation Set Regression
    runs-on: ubuntu-latest
    needs: [rule-consistency, health-check]
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Build Stricture
        run: make build

      - name: Run validation set
        run: STRICTURE_BIN=./bin/stricture ./scripts/run-validation-set.sh

      - name: Upload validation results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: validation-results
          path: /tmp/stricture-validation-*
          if-no-files-found: ignore
          retention-days: 7
