---
import MainLayout from "../layouts/MainLayout.astro";
import { Code } from "astro:components";

export const prerender = true;

const serviceRegistrySnippet = String.raw`flows:
  - id: checkout
    name: Checkout
    level: 1
    owner: Payments platform team
    business_risk: order_loss

systems:
  - id: CheckoutGateway
    name: Checkout Gateway
    owner_team: Payments platform team
    runbook_url: https://runbooks.example.com/checkout-gateway
    doc_root: https://docs.example.com/checkout-gateway
    flows: [checkout]
    escalation:
      - role: primary
        name: Payments Oncall
        channel: pagerduty:payments-oncall
  - id: CheckoutGateway:API
    name: Checkout Gateway API (Java)
    owner_team: Payments platform team
    runbook_url: https://runbooks.example.com/checkout-gateway-api
    doc_root: https://docs.example.com/checkout-gateway-api
    flows: [checkout]
  - id: CheckoutGateway:web-ui
    name: Checkout Gateway Web UI (Node.js)
    owner_team: Payments platform team
    runbook_url: https://runbooks.example.com/checkout-gateway-web-ui
    doc_root: https://docs.example.com/checkout-gateway-web-ui
    flows: [checkout]
`;

const javaSnippet = String.raw`@RestController
@RequestMapping("/v1/checkout")
@Tag(name = "Checkout API") // re-used by Stricture: OpenAPI surface docs
class CheckoutController {

  @WithSpan("checkout.authorize") // re-used by Stricture: OpenTelemetry span context
  @Operation(summary = "Authorize payment")
  @GetMapping("/authorize/{cartId}")
  PaymentResponse authorize(@PathVariable String cartId) {
    // strict-source: CheckoutGateway:API
    //   scope: cross_repo
    //   contract: git+https://github.com/acme/payment-core//openapi.yaml@9a12
    // re-used by Stricture, batteries included: OpenAPI + OTel + strict provenance
    return checkoutService.authorize(cartId);
  }
}
`;

const protobufSnippet = String.raw`syntax = "proto3";

package checkout.v1;

import "google/api/annotations.proto";

service CheckoutService {
  rpc Authorize(AuthorizeRequest) returns (AuthorizeResponse) {
    option (google.api.http) = { get: "/v1/checkout/authorize/{cart_id}" };
  }
}

message AuthorizeResponse {
  // Stricture annotations attach to concrete output fields.
  // re-used by Stricture: Buf/proto schema docs and field identity
  // strict-source: CheckoutGateway:API
  //   scope: cross_repo
  //   contract: buf://acme/payment-core/payment/v1/payment.proto
  string payment_status = 1;
}
`;

const goSnippet = String.raw`type CheckoutResponse struct {
  // Keep Stricture field annotations near response emit/transform logic.
  PaymentStatus string ` + "`json:\"payment_status\"`" + `
}

func (h *Handler) Authorize(w http.ResponseWriter, r *http.Request) {
  ctx, span := h.tracer.Start(r.Context(), "checkout.authorize") // re-used by Stricture: OpenTelemetry trace
  defer span.End()

  // strict-source: CheckoutGateway:API
  //   scope: cross_repo
  //   contract: git+https://github.com/acme/payment-core//openapi.yaml@9a12
  // re-used by Stricture, batteries included: OTel + OpenAPI contract pointers
  resp := CheckoutResponse{PaymentStatus: "authorized"}
  _ = ctx
  json.NewEncoder(w).Encode(resp)
}
`;

const pythonSnippet = String.raw`from fastapi import FastAPI
from pydantic import BaseModel
from opentelemetry import trace

app = FastAPI(title="Checkout API")  # re-used by Stricture: OpenAPI generation
tracer = trace.get_tracer(__name__)

class CheckoutResponse(BaseModel):
    payment_status: str

@app.get("/v1/checkout/authorize/{cart_id}", response_model=CheckoutResponse)
def authorize(cart_id: str) -> CheckoutResponse:
    with tracer.start_as_current_span("checkout.authorize"):  # re-used by Stricture: OTel span
        # strict-source: CheckoutGateway:API
        #   scope: cross_repo
        #   contract: git+https://github.com/acme/payment-core//openapi.yaml@9a12
        # re-used by Stricture, batteries included: FastAPI OpenAPI + OTel + strict lineage
        return CheckoutResponse(payment_status="authorized")
`;

const nodeSnippet = String.raw`import express from "express";
import { trace } from "@opentelemetry/api";

const app = express();
const tracer = trace.getTracer("checkout-gateway");

/**
 * @openapi
 * /v1/checkout/authorize/{cartId}:
 *   get:
 *     summary: Authorize payment
 *     responses:
 *       "200":
 *         description: Checkout authorization
 */
app.get("/v1/checkout/authorize/:cartId", (req, res) => {
  tracer.startActiveSpan("checkout.authorize", (span) => { // re-used by Stricture: OTel
    // strict-source: CheckoutGateway:web-ui
    //   scope: cross_repo
    //   contract: git+https://github.com/acme/payment-core//openapi.yaml@9a12
    // re-used by Stricture, batteries included: OpenAPI JSDoc + OTel + strict lineage
    res.json({ payment_status: "authorized" });
    span.end();
  });
});
`;

const policyBindingSnippet = String.raw`# .stricture.yml
stricture_policy_url: https://policies.example.com/stricture/strict-policy.yaml
stricture_policy_sha256: <optional_sha256_pin>
stricture_server_url: https://stricture.example.com
`;

const policySnippet = String.raw`# .stricture/strict-policy.yaml
schema_version: 1
policy_id: production_standard # org-provided string; can be any useful value

lineage:
  findings:
    require_downstream_impact: true
    flow_criticality:
      enabled: true
      level_direction: lower_is_more_critical
      fail_on_level: 1
      critical_flow_ids: [checkout]
      critical_flow_block_reason: "Risk of order loss"
  require:
    system_registry_keys:
      - escalation
      - runbook_url
      - doc_root
`;

const aviationShippingSnippet = String.raw`flows:
  - id: cargo-tracking
    level: 1
    owner: ops-logistics
  - id: flight-ops
    level: 1
    owner: ops-flight
systems:
  - id: CargoTelemetry
    flows: [cargo-tracking]
    business_risk: safety_delay
  - id: FlightOpsGateway
    flows: [flight-ops]
    business_risk: incident_response
`;

const administrationSnippet = String.raw`flows:
  - id: licensing
    level: 1
    owner: admin-services
  - id: payments
    level: 2
    owner: finance-ops
systems:
  - id: PermitGateway
    flows: [licensing]
    business_risk: compliance_delay
  - id: TreasuryAPI
    flows: [payments]
    business_risk: revenue_delay
`;

const industrialSnippet = String.raw`flows:
  - id: plant-control
    level: 1
    owner: manufacturing-ops
  - id: quality-inspection
    level: 2
    owner: qa-ops
systems:
  - id: PLCGateway
    flows: [plant-control]
    business_risk: safety_shutdown
  - id: BatchQAService
    flows: [quality-inspection]
    business_risk: scrap_cost
`;

const aviationShippingCode = String.raw`// Cargo Telemetry (Go)
// strict-source: CargoTelemetry
//   scope: cross_repo
//   contract: openapi://flight-ops/track
func (h *Handler) TrackCargo(w http.ResponseWriter, r *http.Request) {
  resp := TrackCargoResponse{EtaMinutes: 42}
  json.NewEncoder(w).Encode(resp)
}`;

const administrationCode = String.raw`// Permit Gateway (Java)
// strict-source: PermitGateway
//   scope: cross_repo
//   contract: openapi://treasury/permit
return Response.ok(new PermitResponse("APPROVED")).build();`;

const industrialCode = String.raw`# PLC Gateway (Python)
# strict-source: PLCGateway
#   scope: cross_repo
#   contract: openapi://qa/metrics
return {"temperature_c": 412.3}`;

const examples = [
  {
    id: "java",
    tabLabel: "Java",
    title: "Java + OpenTelemetry + OpenAPI",
    description: "API subsystem is Java (`CheckoutGateway:API`) with field-level lineage near response emit logic.",
    links: [
      { label: "Annotation Guide", href: "/annotations" },
      { label: "Annotation Quality", href: "/annotation-quality" },
    ],
    lang: "java",
    code: javaSnippet,
  },
  {
    id: "proto",
    tabLabel: "Protobuf/Buf",
    title: "Protobuf + Buf",
    description: "Contracts stay in proto/buf, but Stricture annotations still attach at output field level and use the Java API subsystem as source.",
    links: [
      { label: "Annotation Guide", href: "/annotations" },
      { label: "Open Standard", href: "/open-standard" },
    ],
    lang: "proto",
    code: protobufSnippet,
  },
  {
    id: "go",
    tabLabel: "Go",
    title: "Golang + net/http + OTel",
    description: "Go example keeps Stricture annotations at field emit points; service-level owner/runbook/docs remain in the registry systems[] section.",
    links: [
      { label: "Annotation Guide", href: "/annotations" },
      { label: "Annotation Quality", href: "/annotation-quality" },
    ],
    lang: "go",
    code: goSnippet,
  },
  {
    id: "python",
    tabLabel: "Python",
    title: "Python + FastAPI + OTel",
    description: "FastAPI OpenAPI generation plus OTel tracing, with Stricture lineage comments on response fields.",
    links: [
      { label: "Annotation Guide", href: "/annotations" },
      { label: "Getting Started", href: "/getting-started" },
    ],
    lang: "python",
    code: pythonSnippet,
  },
  {
    id: "node",
    tabLabel: "Node/JavaScript",
    title: "Node.js + Express + OpenAPI JSDoc + OTel",
    description: "Web UI subsystem is Node.js (`CheckoutGateway:web-ui`) with field-level lineage on emitted response fields.",
    links: [
      { label: "Annotation Guide", href: "/annotations" },
      { label: "Getting Started", href: "/getting-started" },
    ],
    lang: "ts",
    code: nodeSnippet,
  },
];
---

<MainLayout
  title="Examples | Stricture"
  description="Practical Stricture annotation examples across Java, Protobuf/Buf, Go, Python, and Node.js with OpenAPI and OpenTelemetry integration."
>
  <section class="card">
    <p class="kicker">Examples</p>
    <h1>Strict annotations in real stacks</h1>
    <p class="lead">
      Reuse OpenAPI, OpenTelemetry, and protobuf/buf, then add strict lineage comments where fields are emitted or transformed.
    </p>
    <p class="muted">
      Pattern: service metadata lives in the registry <code>systems[]</code> section; API/field provenance lives in <code>strict-source</code> comments.
    </p>
    <p class="muted">
      Repo convention: shared files in <code>.stricture/</code> (for example <code>.stricture/strict-lineage-systems.yaml</code>), repo-level settings in <code>.stricture.yml</code>.
    </p>
    <p class="example-links">
      <a href="#service-registry">Service registry</a>
      <span class="link-dot">·</span>
      <a href="#industry-examples">Industry examples</a>
      <span class="link-dot">·</span>
      <a href="#language-examples">Language examples</a>
      <span class="link-dot">·</span>
      <a href="#policy-example">Policy example</a>
    </p>
  </section>

  <section id="service-registry" class="card">
    <h2>Service-level annotations (registry)</h2>
    <p class="muted">
      This is where ownership, escalation, runbooks/docs, and flow tiers live. It is a shared registry file (for example <code>.stricture/strict-lineage-systems.yaml</code>), not inline code comments.
    </p>
    <p class="muted"><strong>What you'll learn:</strong> how services declare ownership, flow tiers, and risk.</p>
    <p class="example-links">
      <a href="/annotations">Annotation Guide</a>
      <span class="link-dot">·</span>
      <a href="/annotation-quality">Annotation Quality</a>
      <span class="link-dot">·</span>
      <a href="/policy">Policy Guide</a>
    </p>
    <p class="muted">
      <code>business_risk</code> is an org-managed risk code token (for example <code>order_loss</code>), not a global built-in enum in Stricture core.
    </p>
    <p class="muted">
      <code>owner_team</code> and flow <code>owner</code> are free-form strings (for example <code>Payments platform team</code> or <code>team.payments-platform</code>). No centralized team inventory is required by default.
    </p>
    <p class="muted">
      Flow tier is defined on the flow catalog row (<code>flows[].level</code>) and services join that tier via <code>systems[].flows: [checkout]</code>.
    </p>
    <div class="code-shell">
      <Code code={serviceRegistrySnippet} lang="yaml" />
    </div>
  </section>

  <section id="industry-examples" class="card">
    <h2>Industry examples</h2>
    <p class="muted">
      Same schema, different risks. Flow tiers and service ownership keep drift findings aligned with real business impact.
    </p>
    <p class="muted"><strong>What you'll learn:</strong> how flows map to real business risks in different industries.</p>
    <div class="panel-grid">
      <div class="panel">
        <h3>Aviation + Shipping</h3>
        <p class="muted">Cargo tracking and flight operations are tier-1 flows with safety or delay risk.</p>
        <div class="code-shell">
          <Code code={aviationShippingSnippet} lang="yaml" />
        </div>
      </div>
      <div class="panel">
        <h3>Administration</h3>
        <p class="muted">Licensing and treasury flows emphasize compliance and revenue continuity.</p>
        <div class="code-shell">
          <Code code={administrationSnippet} lang="yaml" />
        </div>
      </div>
      <div class="panel">
        <h3>Industrial Manufacturing</h3>
        <p class="muted">Plant control and QA flows capture safety shutdown and scrap-cost risk.</p>
        <div class="code-shell">
          <Code code={industrialSnippet} lang="yaml" />
        </div>
      </div>
    </div>
  </section>

  <section id="industry-language-examples" class="card">
    <h2>Industry language examples</h2>
    <p class="muted">Same industries, now shown as annotated code in realistic stacks.</p>
    <p class="muted"><strong>What you'll learn:</strong> how `strict-source` looks in Go, Java, and Python.</p>
    <div class="panel-grid">
      <div class="panel">
        <h3>Aviation + Shipping (Go)</h3>
        <p class="muted">Cargo telemetry emitted from a Go handler.</p>
        <div class="code-shell">
          <Code code={aviationShippingCode} lang="go" />
        </div>
      </div>
      <div class="panel">
        <h3>Administration (Java)</h3>
        <p class="muted">Permit status emitted from a Java gateway.</p>
        <div class="code-shell">
          <Code code={administrationCode} lang="java" />
        </div>
      </div>
      <div class="panel">
        <h3>Industrial Manufacturing (Python)</h3>
        <p class="muted">Plant control metrics emitted from a Python service.</p>
        <div class="code-shell">
          <Code code={industrialCode} lang="python" />
        </div>
      </div>
    </div>
  </section>

  <section id="language-examples" class="card">
    <h2>Language examples (tabbed)</h2>
    <p class="muted">
      Same topology, different stack: API is Java (<code>CheckoutGateway:API</code>) and web UI is Node.js (<code>CheckoutGateway:web-ui</code>).
    </p>
    <p class="muted"><strong>What you'll learn:</strong> how to reuse OpenAPI, OTel, and Buf metadata with Stricture.</p>
    <div class="example-tabs" role="tablist" aria-label="Language examples">
      {examples.map((example, idx) => (
        <button
          type="button"
          class={`example-tab ${idx === 0 ? "is-active" : ""}`}
          data-example-tab={example.id}
          role="tab"
          aria-selected={idx === 0 ? "true" : "false"}
        >
          {example.tabLabel}
        </button>
      ))}
    </div>

    {examples.map((example, idx) => (
      <div
        class={`example-panel ${idx === 0 ? "is-active" : ""}`}
        data-example-panel={example.id}
        hidden={idx !== 0}
      >
        <h3 class="example-subhead">{example.title}</h3>
        <p class="muted">{example.description}</p>
        <p class="example-links">
          {example.links.map((link, linkIdx) => (
            <>
              <a href={link.href}>{link.label}</a>
              {linkIdx < example.links.length - 1 ? <span class="link-dot">·</span> : null}
            </>
          ))}
        </p>
        <div class="code-shell">
          <Code code={example.code} lang={example.lang} />
        </div>
      </div>
    ))}
  </section>

  <section id="policy-example" class="card">
    <h2><a href="/policy">Policy example (flow-tier gating)</a></h2>
    <p class="muted">
      Repo-level pointers go in <code>.stricture.yml</code>; policy content can live in <code>.stricture/strict-policy.yaml</code> (or remote URL).
      See the <a href="/policy">Policy Guide</a> for required/optional fields and best practices.
    </p>
    <p class="muted"><strong>What you'll learn:</strong> how flow tiers turn drift findings into CI gates.</p>
    <div class="code-shell">
      <Code code={policyBindingSnippet} lang="yaml" />
    </div>
    <div class="code-shell">
      <Code code={policySnippet} lang="yaml" />
    </div>
    <p class="muted">
      Where checkout tier is declared: flow catalog sets <code>checkout level=1</code>; services bind themselves to checkout via <code>systems[].flows</code>; policy then gates with <code>flow_criticality.fail_on_level</code> and/or <code>critical_flow_ids</code>.
    </p>
  </section>
</MainLayout>

<script is:inline>
  (() => {
    const tabs = Array.from(document.querySelectorAll("[data-example-tab]"));
    const panels = Array.from(document.querySelectorAll("[data-example-panel]"));
    if (!tabs.length || !panels.length) return;

    const activate = (id) => {
      tabs.forEach((tab) => {
        const active = tab.dataset.exampleTab === id;
        tab.classList.toggle("is-active", active);
        tab.setAttribute("aria-selected", active ? "true" : "false");
      });
      panels.forEach((panel) => {
        const active = panel.dataset.examplePanel === id;
        panel.classList.toggle("is-active", active);
        panel.hidden = !active;
      });
    };

    tabs.forEach((tab) => {
      tab.addEventListener("click", () => activate(tab.dataset.exampleTab || ""));
    });
  })();
</script>

<style>
  .code-shell {
    border: 1px solid var(--line);
    border-radius: 12px;
    overflow: hidden;
    margin-top: 0.65rem;
  }

  .code-shell :global(pre.astro-code) {
    margin: 0;
    padding: 1rem;
    font-size: 0.79rem;
    line-height: 1.45;
    overflow-x: auto;
  }

  .example-subhead {
    margin: 0.8rem 0 0.3rem;
    font-size: 0.95rem;
  }

  .example-links {
    margin: 0 0 0.5rem;
    font-size: 0.78rem;
    color: var(--ink-soft);
  }

  .example-links a {
    color: var(--accent);
    text-decoration: none;
    font-weight: 600;
  }

  .example-links a:hover,
  .example-links a:focus-visible {
    text-decoration: underline;
  }

  .link-dot {
    margin: 0 0.35rem;
    color: var(--ink-soft);
  }

  .example-tabs {
    display: flex;
    flex-wrap: wrap;
    gap: 0.4rem;
    margin: 0.55rem 0 0.65rem;
  }

  .example-tab {
    border: 1px solid var(--line);
    border-radius: 999px;
    padding: 0.3rem 0.7rem;
    font-size: 0.8rem;
    background: #ffffff;
    color: var(--ink);
    cursor: pointer;
  }

  .example-tab.is-active {
    border-color: var(--brand);
    background: color-mix(in srgb, var(--brand) 12%, #ffffff);
    color: var(--brand-ink);
    font-weight: 600;
  }

  .example-panel {
    margin-top: 0.4rem;
  }
</style>
