---
import MainLayout from "../layouts/MainLayout.astro";
import demoScript from "../scripts/demo-app.js?url";

export const prerender = true;
---

<MainLayout title="Stricture Demo | Live Drift Simulation">
  <section class="demo-shell">
    <header class="demo-header">
      <div>
        <p class="kicker">Interactive Demo</p>
        <h1>Topology + Drift Lab</h1>
        <p class="hint">Apply a mutation, rerun, and watch how findings change across services.</p>
      </div>
      <div id="gate-banner" class="gate-banner gate-ok">Awaiting first run</div>
    </header>

    <div class="demo-layout">
      <aside class="demo-controls">
        <h2>Quick Scenarios</h2>
        <label>
          Preset
          <select id="preset-scenario"></select>
        </label>
        <button id="apply-scenario" class="button button-secondary">Load Scenario</button>
        <p class="hint" id="scenario-narrative">Choose a preset to see the drift story and its blast radius.</p>

        <h2>Mutations</h2>
        <label>
          Type
          <select id="mutation-type">
            <option value="type_changed">Type Changed</option>
            <option value="enum_changed">Enum Changed</option>
            <option value="field_removed">Field Removed</option>
            <option value="source_version_changed">Source Version Changed</option>
            <option value="external_as_of_stale">External As-Of Stale</option>
            <option value="annotation_missing">Annotation Missing</option>
          </select>
        </label>
        <label>
          Service
          <select id="mutation-service"></select>
        </label>
        <label>
          Field ID
          <select id="mutation-field"></select>
        </label>
        <p class="hint" id="control-stats"></p>
        <button id="apply-mutation" class="button button-primary">Apply Mutation</button>

        <h2>Policy</h2>
        <label>
          Mode
          <select id="policy-mode">
            <option value="warn">warn</option>
            <option value="block">block</option>
          </select>
        </label>
        <label>
          Fail On
          <select id="policy-fail-on">
            <option value="high">high</option>
            <option value="medium">medium</option>
            <option value="low">low</option>
          </select>
        </label>
        <p class="hint">Block: stop deploy when severity ≥ threshold. Warn: allow deploy but surface findings.</p>
        <button id="update-policy" class="button button-secondary">Update Policy</button>

        <h2>Override</h2>
        <label>
          Field ID
          <input id="override-field" type="text" placeholder="response_payment_status" />
        </label>
        <label>
          Change Type
          <input id="override-change" type="text" placeholder="field_removed or *" />
        </label>
        <label>
          Expires
          <input id="override-expires" type="date" />
        </label>
        <label>
          Reason
          <input id="override-reason" type="text" placeholder="migration window" />
        </label>
        <label>
          Ticket
          <input id="override-ticket" type="text" placeholder="INC-123" />
        </label>
        <p class="hint">Use * to cover any change type; set an expiry so temporary overrides auto-expire.</p>
        <button id="add-override" class="button button-secondary">Add Override</button>

        <div class="control-actions">
          <button id="run-stricture" class="button button-primary">Rerun Stricture</button>
          <button id="reset-session" class="button button-secondary">Reset Session</button>
        </div>
      </aside>

      <section class="demo-main">
        <article class="card">
          <h2>Findings</h2>
          <p class="muted" id="run-summary-text">Awaiting first run. Apply a mutation then rerun to see flags.</p>
          <div id="findings" class="list"></div>
        </article>

        <article class="card">
          <h2>Service Topology</h2>
          <p class="muted">Visualize how services (big nodes) and field-level flows (thin edges) connect. Nodes inherit the worst finding on that service; edges show per-field status.</p>
          <div class="legend">
            <span class="legend-chip legend-node-ok">Service node</span>
            <span class="legend-chip legend-edge-healthy">Field flow (healthy)</span>
            <span class="legend-chip legend-edge-warning">Field flow (warn)</span>
            <span class="legend-chip legend-edge-blocked">Field flow (blocked)</span>
          </div>
          <div id="topology-graph" class="topology-graph flow-graph"></div>
          <p class="muted tight" id="flow-path-summary">Loading flow...</p>
          <div id="topology" class="topology"></div>
          <div class="edge-list-wrap">
            <p class="muted tight">Field-level flows (per edge). Each row: source → target | field | status.</p>
            <div id="edge-list" class="edge-list"></div>
          </div>
        </article>

        <article class="card dual">
          <div>
            <h2>Active Overrides</h2>
            <div id="overrides" class="list"></div>
          </div>
          <div>
            <h2>Escalation Chain</h2>
            <div class="row">
              <select id="escalation-service"></select>
              <button id="load-escalation" class="button button-secondary">Load Chain</button>
            </div>
            <div id="escalation" class="list"></div>
          </div>
        </article>
      </section>
    </div>
  </section>

  <script type="module" src={demoScript}></script>

  <section class="card how-it-works">
    <h2>How this demo works</h2>
    <p class="muted">
      “Is this indicative of what the binary can do?” <strong>Yes</strong>—the scenarios, severities, remediation text, and escalation chains are generated by the Go reference engine. At build time we run the Go demo pack generator to produce a snapshot (topology, mutation outcomes, overrides behavior) that the Cloudflare Worker uses at runtime. The browser talks only to the Worker APIs for speed and zero server dependencies, but the logic you’re seeing is derived from the same engine the CLI runs.
    </p>
    <p class="muted">Build-time inputs: Go demo-pack generator → JSON/TS artifacts. Runtime: Cloudflare Worker applies policy/overrides on that pack for instant responses.</p>
  </section>
</MainLayout>
