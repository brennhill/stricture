---
import MainLayout from "../layouts/MainLayout.astro";
import demoScript from "../scripts/demo-app.js?url";

export const prerender = true;
---

<MainLayout title="Stricture Demo | Live Drift Simulation">
  <section class="demo-shell">
    <header class="demo-header">
      <div>
        <p class="kicker">Interactive Demo</p>
        <h1>Topology + Drift Lab</h1>
        <p class="hint">Apply a change and watch findings update instantly across services.</p>
      </div>
      <div id="gate-banner" class="gate-banner gate-ok">Awaiting first run</div>
    </header>

    <div class="demo-layout">
      <aside class="demo-controls">
        <h2>Quick Scenarios</h2>
        <label>
          Preset
          <select id="preset-scenario"></select>
        </label>
        <p class="hint" id="scenario-narrative">Choose a preset to see the drift story and its blast radius.</p>
        <p class="hint">
          Need clearer findings? Read the <a href="/annotation-quality">Annotation Quality Guide</a>.
        </p>
        <p class="hint">
          Want a focused subsystem example? Open the <a href="/service-internals-demo">Service Internals Demo</a>.
        </p>

        <h2>Mutations</h2>
        <label>
          Service
          <select id="mutation-service"></select>
        </label>
        <label>
          Field
          <select id="mutation-field"></select>
        </label>
        <label>
          Change
          <select id="mutation-type">
            <option value="type_changed">Field type changed</option>
            <option value="enum_changed">Enum values updated</option>
            <option value="field_removed">Field removed</option>
            <option value="source_version_changed">Source version changed</option>
            <option value="external_as_of_stale">External snapshot stale</option>
            <option value="annotation_missing">Annotation missing</option>
          </select>
        </label>
        <p class="hint">Pick service first. Field choices filter by service, then available changes filter by field.</p>
        <p class="hint" id="control-stats"></p>
        <button id="apply-mutation" class="button button-primary">Apply change</button>

        <h2>Policy</h2>
        <label>
          Gate mode
          <select id="policy-mode">
            <option value="warn">warn</option>
            <option value="block">block</option>
          </select>
        </label>
        <label>
          Block when severity is at least
          <select id="policy-fail-on">
            <option value="high">high</option>
            <option value="medium">medium</option>
            <option value="low">low</option>
          </select>
        </label>
        <label>
          Critical flow
          <select id="policy-critical-flow"></select>
        </label>
        <label>
          <input id="policy-require-impact" type="checkbox" />
          Require downstream impact
        </label>
        <label>
          <input id="policy-flow-hard-block" type="checkbox" />
          Flow criticality hard block
        </label>
        <label>
          Unknown impact severity
          <select id="policy-unknown-impact">
            <option value="low">low</option>
            <option value="medium">medium</option>
            <option value="high">high</option>
            <option value="info">info</option>
          </select>
        </label>
        <label>
          <input id="policy-self-only" type="checkbox" />
          Emit findings for self-only changes
        </label>
        <label>
          Self-only severity
          <select id="policy-self-only-severity">
            <option value="low">low</option>
            <option value="medium">medium</option>
            <option value="high">high</option>
            <option value="info">info</option>
          </select>
        </label>
        <label>
          Hard-block reason shown in findings
          <input id="policy-hard-block-reason" type="text" value="Risk of order loss" />
        </label>
        <p class="hint" id="policy-coverage" title="Demo uses a policy-pack subset. Additional fields are documented but not yet enforced."></p>
        <p class="hint" id="policy-impact-tip" title="Policy only affects staged changes in this session. Stage a mutation first, or clear staged changes to return to baseline.">Policy only affects staged changes in this session. Stage a change first.</p>
        <button id="update-policy" class="button button-primary">Apply policy</button>
        <div class="code-shell">
          <pre id="policy-pack-preview"></pre>
        </div>

        <div class="control-actions">
          <button id="run-stricture" class="button button-primary">Rerun Stricture</button>
          <button id="reset-session" class="button button-secondary">Clear staged changes</button>
        </div>
      </aside>

      <section class="demo-main">
        <article class="card">
          <h2>Findings</h2>
          <p class="muted" id="run-summary-text">Awaiting first run. Apply a change to see what changed, which service caused it, and which services are impacted.</p>
          <div id="findings" class="list"></div>
        </article>

        <article class="card">
          <h2>Ecosystem Topology</h2>
          <p class="muted">Ecosystem view groups each top-level service as one node. Click a service with internals to drill into its subsystem topology. Red node = source change. Orange node = impacted service. Pale yellow node = relay on impacted path. Light yellow node = possible contributor. Orange edge = affected path.</p>
          <div class="topology-view-tabs" role="tablist" aria-label="Topology level">
            <button id="topology-tab-ecosystem" class="button button-secondary topology-tab" role="tab" aria-selected="true">Ecosystem</button>
            <span id="topology-tab-service-wrap" class="topology-tab-wrap" data-tooltip="Select a highlighted service node with a layers icon to unlock Service Internals.">
              <button id="topology-tab-service" class="button button-secondary topology-tab" role="tab" aria-selected="false" disabled>Service Internals</button>
            </span>
            <span id="topology-tab-field-wrap" class="topology-tab-wrap" data-tooltip="Stage a change or load a preset to unlock Field Path.">
              <button id="topology-tab-field" class="button button-secondary topology-tab" role="tab" aria-selected="false" disabled>Field Path</button>
            </span>
          </div>
          <p class="muted tight" id="topology-view-state">Ecosystem view. Click a service node to inspect internals.</p>
          <p class="hint" id="topology-view-guidance">Service Internals unlocks after selecting a service node. Field Path unlocks after staging a change or loading a preset.</p>
          <div class="legend">
            <span class="legend-chip legend-node-source">Source changed</span>
            <span class="legend-chip legend-node-impacted">Service impacted</span>
            <span class="legend-chip legend-node-transit">Path relay</span>
            <span class="legend-chip legend-node-contributor">Possible data contributor</span>
            <span class="legend-chip legend-node-drillable">Inspectable internals</span>
            <span class="legend-chip legend-edge-affected">Affected path</span>
            <span class="legend-chip legend-edge-healthy">Other healthy flow</span>
          </div>
          <div id="topology-graph" class="topology-graph flow-graph"></div>
          <p class="muted tight" id="flow-path-summary">Loading flow...</p>
          <div id="topology" class="topology"></div>
          <div class="edge-list-wrap">
            <div class="edge-list-header">
              <p class="muted tight">Field-level flows (per edge). Each row: source → target | field | status.</p>
              <button id="toggle-edges" class="button button-secondary button-ghost">Show details</button>
            </div>
            <div id="edge-list" class="edge-list is-collapsed"></div>
          </div>
        </article>

      </section>
    </div>
  </section>

  <script type="module" src={demoScript}></script>

  <section class="card how-it-works">
    <h2>How this demo works</h2>
    <p class="muted">
      “Is this indicative of what the binary can do?” <strong>Yes</strong>—the scenarios, severities, remediation text, and escalation chains are generated by the Go reference engine. At build time we run the Go demo pack generator to produce a snapshot (topology and mutation outcomes) that the Cloudflare Worker uses at runtime. The browser talks only to the Worker APIs for speed and zero server dependencies, but the logic you’re seeing is derived from the same engine the CLI runs.
    </p>
    <p class="muted">Build-time inputs: Go demo-pack generator → JSON/TS artifacts. Runtime: Cloudflare Worker applies policy on that pack for instant responses.</p>
  </section>
</MainLayout>
