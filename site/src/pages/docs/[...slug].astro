---
import MainLayout from "../../layouts/MainLayout.astro";
import { getCollection } from "astro:content";

export async function getStaticPaths() {
  const docs = await getCollection("docs");
  return docs.map((entry) => ({
    params: { slug: entry.slug },
    props: { entry },
  }));
}

const { entry } = Astro.props;
const { Content } = await entry.render();

const toTitle = (value) =>
  String(value || "")
    .replace(/[-_]/g, " ")
    .replace(/\b\w/g, (char) => char.toUpperCase());

const title = entry.data.title || toTitle(entry.slug.split("/").pop());
const description = entry.data.description || "Stricture documentation.";
const editUrl = `https://github.com/brennhill/stricture/blob/main/docs/${entry.slug}.md`;

const allDocs = await getCollection("docs");
const navItems = allDocs
  .map((doc) => ({
    slug: doc.slug,
    title: doc.data.title || toTitle(doc.slug.split("/").pop()),
    order: doc.data.order ?? 9999,
  }))
  .sort((a, b) => {
    if (a.order !== b.order) return a.order - b.order;
    return a.title.localeCompare(b.title);
  });
---

<MainLayout title={`${title} | Stricture Docs`} description={description}>
  <section class="docs-layout">
    <aside class="docs-sidebar">
      <h2>Docs</h2>
      <nav>
        {navItems.map((item) => (
          <a class={item.slug === entry.slug ? "is-active" : ""} href={`/docs/${item.slug}`}>
            {item.title}
          </a>
        ))}
      </nav>
    </aside>
    <article class="docs-content card">
      <div class="docs-header">
        <h1>{title}</h1>
        <a class="docs-edit" href={editUrl} target="_blank" rel="noopener noreferrer">Edit on GitHub</a>
      </div>
      <Content />
    </article>
  </section>
</MainLayout>

<style>
  .docs-layout {
    display: grid;
    gap: 1.5rem;
    grid-template-columns: minmax(180px, 260px) minmax(0, 1fr);
    align-items: start;
  }

  .docs-sidebar {
    position: sticky;
    top: 2rem;
    align-self: start;
    padding: 1rem;
    border: 1px solid var(--line);
    border-radius: 12px;
    background: #ffffff;
    box-shadow: var(--shadow);
  }

  .docs-sidebar h2 {
    margin: 0 0 0.6rem;
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.12em;
    color: var(--ink-soft);
  }

  .docs-sidebar nav {
    display: grid;
    gap: 0.35rem;
  }

  .docs-sidebar a {
    text-decoration: none;
    color: var(--ink);
    font-size: 0.85rem;
    padding: 0.35rem 0.5rem;
    border-radius: 8px;
  }

  .docs-sidebar a.is-active {
    background: color-mix(in srgb, var(--accent) 12%, white);
    color: var(--accent);
    font-weight: 600;
  }

  .docs-content h1 {
    margin-top: 0;
  }

  .docs-header {
    display: flex;
    flex-wrap: wrap;
    gap: 0.6rem;
    align-items: baseline;
    justify-content: space-between;
  }

  .docs-edit {
    font-size: 0.8rem;
    color: var(--accent);
    text-decoration: none;
    font-weight: 600;
  }

  .docs-edit:hover,
  .docs-edit:focus-visible {
    text-decoration: underline;
  }

  @media (max-width: 900px) {
    .docs-layout {
      grid-template-columns: 1fr;
    }
    .docs-sidebar {
      position: static;
    }
  }
</style>
